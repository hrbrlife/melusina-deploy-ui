<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Melusina Deploy Configurator</title>
<style>
:root{--bg:#0d1117;--s1:#161b22;--s2:#1c2333;--bd:#30363d;--bd2:#444c56;
--tx:#e6edf3;--dm:#8b949e;--ac:#58a6ff;--ac2:#1f6feb;--gn:#3fb950;
--rd:#f85149;--or:#d29922;--pu:#bc8cff;--tl:#39d2c0;--r:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--tx);line-height:1.5}
.w{display:flex;gap:20px;max-width:1200px;margin:0 auto;padding:20px 20px 80px}
.w-main{flex:1;min-width:0;max-width:880px}
.w-help{width:280px;flex-shrink:0}
.help-panel{position:sticky;top:20px;background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:16px;max-height:calc(100vh - 40px);overflow-y:auto}
.help-panel .hp-title{font-size:.7rem;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.help-panel .hp-field{font-size:.82rem;font-weight:600;color:var(--tx);margin-bottom:6px}
.help-panel .hp-body{font-size:.76rem;color:var(--dm);line-height:1.55}
.help-panel .hp-body p{margin:6px 0}
.help-panel .hp-empty{font-size:.74rem;color:var(--bd2);font-style:italic}
.hq{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:var(--s2);border:1px solid var(--bd);color:var(--dm);font-size:.58rem;font-weight:700;cursor:pointer;margin-left:5px;transition:.15s;vertical-align:middle;line-height:1;user-select:none;flex-shrink:0}
.hq:hover{border-color:var(--ac);color:var(--ac);background:rgba(88,166,255,.08)}
.hq.active{border-color:var(--ac);color:var(--ac);background:rgba(88,166,255,.12)}
@media(max-width:900px){.w{flex-direction:column}.w-help{width:100%;position:fixed;bottom:0;left:0;right:0;z-index:100;max-height:40vh}.help-panel{position:static;border-radius:var(--r) var(--r) 0 0;max-height:40vh}}
.hero{text-align:center;padding:28px 0 20px}
.hero h1{font-size:1.7rem;font-weight:700;background:linear-gradient(135deg,var(--ac),var(--pu));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero p{color:var(--dm);font-size:.85rem;margin-top:4px}
.hero-bar{display:flex;gap:8px;justify-content:center;margin-top:12px}
.hero-bar button{background:var(--s1);color:var(--dm);border:1px solid var(--bd);border-radius:6px;padding:5px 14px;font-size:.75rem;cursor:pointer}
.hero-bar button:hover{color:var(--tx);border-color:var(--ac)}
.sec{margin-top:28px}.sec-t{font-size:.68rem;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;padding-left:2px}
.pick3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.pk{display:flex;flex-direction:column;align-items:center;gap:8px;padding:22px 14px;
background:var(--s2);border:2px solid var(--bd);border-radius:var(--r);cursor:pointer;text-align:center;transition:.15s;position:relative}
.pk:hover{border-color:var(--ac);transform:translateY(-1px)}
.pk.on{border-color:var(--ac);background:rgba(88,166,255,.07)}
.pk .dot{position:absolute;top:8px;right:10px;width:18px;height:18px;border-radius:50%;border:2px solid var(--bd);display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:transparent;transition:.15s}
.pk.on .dot{border-color:var(--ac);background:var(--ac);color:#000}
.pk-i{font-size:2rem}.pk-l{font-size:.85rem;font-weight:600}.pk-d{font-size:.7rem;color:var(--dm);line-height:1.35}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sv{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--s2);border:1.5px solid var(--bd);border-radius:var(--r);transition:.15s;cursor:pointer;user-select:none}
.sv:hover{border-color:var(--bd2)}.sv.on{border-color:var(--gn);background:rgba(63,185,80,.05)}
.sv.lock{cursor:default;opacity:.9}.sv.lock.on{opacity:1}
.sv-i{font-size:1.3rem;flex-shrink:0}.sv-n{font-size:.82rem;font-weight:600}.sv-d{font-size:.68rem;color:var(--dm)}
.sv-info{flex:1;min-width:0}
.sv-tag{font-size:.58rem;font-weight:700;padding:2px 7px;border-radius:8px;text-transform:uppercase;letter-spacing:.3px}
.sv-tag.r{background:rgba(248,81,73,.12);color:var(--rd)}.sv-tag.o{background:rgba(139,148,158,.1);color:var(--dm)}
.sw{width:36px;height:20px;border-radius:10px;border:none;cursor:pointer;position:relative;transition:.2s;flex-shrink:0;background:var(--bd)}
.sw.on{background:var(--gn)}.sw::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:.2s}.sw.on::after{left:18px}
.sw.lock{opacity:.4;cursor:not-allowed}
.topo{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:20px;position:relative}
.topo-h{font-size:.75rem;color:var(--dm);margin-bottom:14px;display:flex;justify-content:space-between;align-items:center}
.topo-h span{font-size:.68rem;color:var(--dm);font-style:italic}
.t-row{display:flex;align-items:stretch;gap:0;justify-content:center}
.t-n{display:flex;flex-direction:column;align-items:center;gap:3px;padding:14px 18px;background:var(--s2);border:2px solid var(--bd);border-radius:var(--r);min-width:150px;text-align:center;cursor:pointer;transition:.15s}
.t-n:hover{border-color:var(--bd2)}
.t-n.gw{border-color:var(--or)}.t-n.sv{border-color:var(--ac)}.t-n.sc{border-color:var(--pu)}
.t-i{font-size:1.4rem}.t-l{font-size:.78rem;font-weight:600}.t-m{font-size:.65rem;color:var(--dm)}
.t-link{display:flex;flex-direction:column;align-items:center;justify-content:center;width:56px;position:relative}
.t-link::before{content:'';position:absolute;top:50%;left:0;right:0;height:2px;background:var(--bd2)}
.t-link-tag{font-size:.55rem;color:var(--dm);background:var(--s1);padding:0 4px;z-index:1;white-space:nowrap}
.t-pills{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;min-height:24px;padding:5px;border:1.5px dashed transparent;border-radius:6px;transition:.15s;justify-content:center}
.t-pills.drop{border-color:var(--bd2)}.t-pills.drag-over{border-color:var(--ac);background:rgba(88,166,255,.06)}
.pill{padding:3px 8px;border-radius:10px;font-size:.65rem;font-weight:600;cursor:grab;user-select:none;transition:.12s}
.pill.dragging{opacity:.3}
.pill[data-s="WATCHDOG"]{background:rgba(63,185,80,.15);color:var(--gn)}
.pill[data-s="MERMAIL"]{background:rgba(88,166,255,.15);color:var(--ac)}
.pill[data-s="AILAGOON"]{background:rgba(57,210,192,.15);color:var(--tl)}
.pill[data-s="VINTAGE"]{background:rgba(188,140,255,.15);color:var(--pu)}
.pill[data-s="SCREENING"]{background:rgba(210,153,34,.15);color:var(--or)}
.t-sc-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:14px}
.t-add{display:flex;gap:8px;justify-content:center;margin-top:14px}
.t-add button{padding:6px 14px;background:var(--s2);border:1.5px dashed var(--bd2);border-radius:8px;color:var(--dm);cursor:pointer;font-size:.74rem}
.t-add button:hover{border-color:var(--ac);color:var(--ac)}
.t-n .t-rm{position:absolute;top:5px;right:7px;background:none;border:none;color:var(--dm);cursor:pointer;font-size:.75rem}.t-n .t-rm:hover{color:var(--rd)}
.cfg{margin-top:12px;padding:16px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--r);animation:fadeIn .15s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.cfg h4{font-size:.82rem;font-weight:600;margin-bottom:8px}
.f{margin-bottom:10px}
.f label{display:block;font-size:.7rem;font-weight:600;color:var(--dm);margin-bottom:3px;text-transform:uppercase;letter-spacing:.3px}
.f input,.f select,.f textarea{width:100%;padding:8px 10px;background:var(--s1);border:1px solid var(--bd);border-radius:6px;color:var(--tx);font-size:.82rem;font-family:inherit}
.f input:focus,.f textarea:focus{outline:none;border-color:var(--ac)}
.f textarea{resize:vertical;min-height:60px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:.78rem}
.f .h{font-size:.65rem;color:var(--dm);margin-top:2px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.mono{font-family:'SF Mono',Monaco,Consolas,monospace}
.br{display:flex;gap:6px;align-items:end}
.br .f{flex:1}
.brb{padding:8px 12px;background:var(--ac2);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;white-space:nowrap}.brb:hover{background:var(--ac)}
.card{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-top:16px}
.card-t{font-size:.82rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.chs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.ch{padding:6px 14px;background:var(--s2);border:1.5px solid var(--bd);border-radius:16px;cursor:pointer;font-size:.78rem;transition:.12s;user-select:none}
.ch:hover{border-color:var(--ac)}.ch.on{border-color:var(--ac);background:rgba(88,166,255,.1);color:var(--ac);font-weight:600}
.tr{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bd)}
.tr:last-child{border-bottom:none}
.tr-l{font-size:.82rem}.tr-d{font-size:.68rem;color:var(--dm)}
.tgl{width:40px;height:22px;border-radius:11px;border:none;cursor:pointer;position:relative;transition:.2s;flex-shrink:0;background:var(--bd)}
.tgl.on{background:var(--gn)}
.tgl::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}.tgl.on::after{left:20px}
.wbar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.wb{padding:6px 12px;border-radius:7px;border:1.5px solid var(--bd);background:var(--s2);color:var(--dm);cursor:pointer;font-size:.74rem;font-weight:600;transition:.12s}
.wb:hover{border-color:var(--ac);color:var(--tx)}.wb.on{border-color:var(--gn);color:var(--gn)}
.wb.det::before{content:'‚óè';margin-right:4px;color:var(--gn);font-size:.5rem}
.cond{display:none}.cond.show{display:block}
.dns-r{display:grid;grid-template-columns:2fr 1fr 3fr auto;gap:6px;align-items:end;margin-bottom:6px}
.dns-r .f{margin-bottom:0}
.xbtn{background:none;border:none;color:var(--dm);cursor:pointer;font-size:.9rem;padding:2px}.xbtn:hover{color:var(--rd)}
.cks{list-style:none;max-height:280px;overflow-y:auto}
.cks li{display:flex;align-items:center;gap:7px;padding:5px 0;font-size:.78rem;border-bottom:1px solid var(--bd)}
.ck{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;flex-shrink:0}
.ck.p{background:rgba(63,185,80,.12);color:var(--gn)}.ck.f{background:rgba(248,81,73,.12);color:var(--rd)}.ck.w{background:rgba(210,153,34,.12);color:var(--or)}
.ebar{display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:9px 18px;border-radius:8px;border:none;cursor:pointer;font-size:.82rem;font-weight:600;transition:.12s}
.btn-p{background:var(--ac2);color:#fff}.btn-p:hover{background:var(--ac)}
.btn-s{background:var(--s2);color:var(--tx);border:1px solid var(--bd)}.btn-s:hover{border-color:var(--ac)}
#env-out{display:none;width:100%;max-height:380px;overflow:auto;padding:12px;background:#0a0e14;border:1px solid var(--bd);border-radius:var(--r);font-family:monospace;font-size:.74rem;white-space:pre;color:var(--dm);margin-top:12px}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--s2);color:var(--tx);padding:8px 22px;border-radius:8px;border:1px solid var(--bd);font-size:.8rem;z-index:9999;transition:.25s;opacity:0;pointer-events:none}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
details{margin-top:10px}details summary{cursor:pointer;font-size:.74rem;color:var(--dm);padding:5px 0}details summary:hover{color:var(--ac)}details[open] summary{color:var(--ac);margin-bottom:6px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
@media(max-width:640px){.pick3,.sg{grid-template-columns:1fr}.row,.row3{grid-template-columns:1fr}.dns-r{grid-template-columns:1fr}}
.buy-box{margin-top:8px;padding:12px;background:rgba(88,166,255,.05);border:1px solid var(--ac);border-radius:var(--r)}
.buy-box .buy-t{font-size:.78rem;font-weight:600;color:var(--ac);margin-bottom:6px}
.buy-box .buy-d{font-size:.72rem;color:var(--dm);margin-bottom:8px}
.buy-box .buy-p{font-size:1rem;font-weight:700;color:var(--gn);margin-bottom:8px}
.buy-btn{padding:8px 20px;background:var(--gn);color:#000;border:none;border-radius:8px;cursor:pointer;font-size:.82rem;font-weight:700;transition:.12s}
.buy-btn:hover{background:#4eca5e}
.buy-btn:disabled{opacity:.4;cursor:not-allowed}
.ez-checks{display:flex;flex-direction:column;gap:8px}
.ez-row{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;cursor:pointer;transition:.15s}
.ez-row:hover{border-color:var(--bd2)}.ez-q{font-size:.82rem;font-weight:600}.ez-d{font-size:.68rem;color:var(--dm)}
[data-ez="hide"].ez-hidden{display:none!important}
</style>
<script src="https://unpkg.com/@solana/web3.js@1.95.5/lib/index.iife.min.js"></script>
</head>
<body>
<div class="w">
<div class="w-main">

<!-- HERO -->
<div class="hero">
  <h1>Melusina Deploy Configurator</h1>
  <p>Build your deployment.env ‚Äî the deploy script handles everything else.</p>
  <div class="hero-bar">
    <button onclick="document.getElementById('imp').click()">Import .env</button> <span class="hq" onclick="showHelp('btn-import',event)">?</span>
    <input type="file" id="imp" accept=".env,.txt" style="display:none" onchange="importFile(this)">
    <button onclick="resetAll()">Reset</button> <span class="hq" onclick="showHelp('btn-reset',event)">?</span>
  </div>
</div>

<!-- INSTALL MODE -->
<div class="sec" id="sec-mode"><div class="sec-t">Install Mode <span class="hq" onclick="showHelp('sec-mode',event)">?</span></div>
<div class="card" style="padding:18px 20px">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <div>
      <div style="font-size:.88rem;font-weight:700;color:var(--gn)" id="mode-label">üü¢ Easy Mode</div>
      <div style="font-size:.68rem;color:var(--dm)" id="mode-hint">All switches on ‚Äî only essential steps shown</div>
    </div>
  </div>
  <div class="ez-checks">
    <div class="ez-row" onclick="toggleEz(0)">
      <button class="tgl on" id="ez-0" style="pointer-events:none"></button>
      <div><div class="ez-q">This is a first-time deploy</div><div class="ez-d">I'm not upgrading or migrating an existing instance</div></div>
    </div>
    <div class="ez-row" onclick="toggleEz(1)">
      <button class="tgl on" id="ez-1" style="pointer-events:none"></button>
      <div><div class="ez-q">I have no other services on this machine</div><div class="ez-d">Clean server ‚Äî no port conflicts or shared infrastructure</div></div>
    </div>
    <div class="ez-row" onclick="toggleEz(2)">
      <button class="tgl on" id="ez-2" style="pointer-events:none"></button>
      <div><div class="ez-q">I don't have a license yet</div><div class="ez-d">I need to purchase a Melusina license NFT</div></div>
    </div>
  </div>
</div>
</div>

<!-- 1. DOMAIN ‚Äî the most important thing -->
<div class="sec"><div class="sec-t">Choose Your Subdomain <span class="hq" onclick="showHelp('sec-domain',event)">?</span></div>
<div class="card">
  <!-- Big clear subdomain hero -->
  <div id="domain-label-hero" style="text-align:center;padding:12px 0 6px">
    <div style="font-size:.72rem;color:var(--dm);margin-bottom:8px">Your Melusina instance will be at:</div>
    <div style="display:flex;align-items:center;justify-content:center;gap:0;max-width:420px;margin:0 auto">
      <input id="subdomain-label-input" placeholder="myname" style="border-radius:7px 0 0 7px;border-right:none;min-width:100px;flex:1;font-size:1.05rem;padding:10px 14px;text-align:right;font-weight:600" oninput="onLabelInput(this.value)">
      <span id="domain-suffix" style="padding:10px 14px;background:var(--s2);border:1px solid var(--bd);border-radius:0 7px 7px 0;font-size:1.05rem;color:var(--ac);white-space:nowrap;font-family:monospace;font-weight:600">.dev.pbay.app</span>
    </div>
    <div id="domain-preview" style="font-size:.82rem;color:var(--gn);margin-top:8px;font-weight:600;min-height:1.2em"></div>
    <div style="font-size:.62rem;color:var(--dm);margin-top:4px">Letters, numbers, and hyphens only ¬∑ 3‚Äì63 characters</div>
  </div>
  <!-- Hidden BYOD fallback (only shown if reseller has NO base_domain) -->
  <div id="domain-byod" style="display:none">
    <div class="f"><label>Full Domain <span class="hq" onclick="showHelp('MELUSINA_DOMAIN',event)">?</span></label>
    <input data-k="MELUSINA_DOMAIN" placeholder="app.melusina-os.org" oninput="deriveDns();debounceLicenseCheck()"></div>
  </div>
  <div id="dns-derived"></div>
  <div id="license-check" style="margin-top:8px"></div>
  <div id="zone-sov-wrap" style="display:none">
    <div style="font-size:.72rem;color:var(--dm);margin-top:10px">Do you own this domain? <span class="hq" onclick="showHelp('zone-sovereignty',event)">?</span></div>
    <div class="chs" style="margin-top:4px">
      <div class="ch on" data-r="MELUSINA_ZONE_SOVEREIGNTY" data-v="subdomain" onclick="pickR(this)" title="e.g. app.yourreseller.com ‚Äî reseller controls the parent domain">No, it's a subdomain</div>
      <div class="ch" data-r="MELUSINA_ZONE_SOVEREIGNTY" data-v="full" onclick="pickR(this)" title="e.g. mycompany.com ‚Äî you control the entire DNS zone">Yes, I own it</div>
    </div>
    <div id="zone-hint" style="font-size:.62rem;color:var(--dm);margin-top:4px">Most buyers use a subdomain provided by their reseller. Choose "Yes, I own it" only if you registered the domain yourself.</div>
  </div>
  <details><summary>Extra DNS records <span class="hq" onclick="showHelp('EXTRA_DNS',event)">?</span></summary>
    <div class="f"><label>One record per line</label><textarea data-k="EXTRA_DNS" placeholder="mail  A  1.2.3.4&#10;_dmarc  TXT  v=DMARC1; p=none&#10;mx  MX  10 mail.example.com" style="min-height:80px"></textarea>
      <div class="h">Format: name  type  value (space or tab separated)</div></div>
  </details>
</div>
</div>

<!-- 2. RESELLER & NETWORK -->
<div class="sec" data-ez="hide"><div class="sec-t">Reseller &amp; Network <span class="hq" onclick="showHelp('sec-reseller',event)">?</span></div>
<div class="card">
  <div class="chs" style="margin-bottom:10px">
    <div class="ch on" data-r="BLOCKCHAIN_NETWORK" data-v="devnet" onclick="pickR(this);debounceLicenseCheck()">Devnet</div>
    <div class="ch" data-r="BLOCKCHAIN_NETWORK" data-v="mainnet-beta" onclick="pickR(this);debounceLicenseCheck()">Mainnet</div>
    <span class="hq" onclick="showHelp('BLOCKCHAIN_NETWORK',event)">?</span>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:.75rem;color:var(--dm)">Select your reseller (by NFT common name)</span>
    <button class="brb" onclick="fetchResellers()" style="padding:4px 10px;font-size:.7rem">Fetch Resellers</button>
  </div>
  <div id="reseller-list"></div>
</div>
</div>

<!-- 3. WHERE ARE YOU DEPLOYING FROM -->
<div class="sec" data-ez="hide"><div class="sec-t">Where are you deploying from? <span class="hq" onclick="showHelp('sec-target',event)">?</span></div>
<div class="pick3" id="target-pick">
  <div class="pk" onclick="pickTarget('local')" data-t="local">
    <div class="dot">‚úì</div><div class="pk-i">üñ•Ô∏è</div>
    <div class="pk-l">This Machine <span class="hq" onclick="event.stopPropagation();showHelp('target-local',event)">?</span></div>
    <div class="pk-d">Server runs right here.<br>No SSH needed.</div></div>
  <div class="pk" onclick="pickTarget('remote_from')" data-t="remote_from">
    <div class="dot">‚úì</div><div class="pk-i">üöÄ</div>
    <div class="pk-l">Remote ‚Äî Deploy From Here <span class="hq" onclick="event.stopPropagation();showHelp('target-remote_from',event)">?</span></div>
    <div class="pk-d">Your workstation pushes<br>to a remote server via SSH.</div></div>
  <div class="pk" onclick="pickTarget('remote_on')" data-t="remote_on">
    <div class="dot">‚úì</div><div class="pk-i">üì¶</div>
    <div class="pk-l">Carry &amp; Install <span class="hq" onclick="event.stopPropagation();showHelp('target-remote_on',event)">?</span></div>
    <div class="pk-d">Take the .env and package to<br>the target machine, run there.</div></div>
</div>
</div>

<!-- PACKAGE SOURCE ‚Äî store (via reseller) or local bundle -->
<div class="sec" data-ez="hide" style="margin-top:16px"><div class="sec-t">Package Source <span class="hq" onclick="showHelp('sec-source',event)">?</span></div>
<div class="card">
  <div class="chs">
    <div class="ch" data-r="SOURCE_MODE" data-v="store" onclick="pickR(this);updateStoreStatus()">Download from Store</div>
    <div class="ch on" data-r="SOURCE_MODE" data-v="local" onclick="pickR(this)">Local Bundle</div>
    <span class="hq" onclick="showHelp('source-store',event)">?</span>
  </div>
  <div class="cond" data-show="v:SOURCE_MODE:store">
    <div id="store-status" style="padding:8px 12px;background:var(--s2);border-radius:8px;font-size:.75rem"></div>
  </div>
  <div class="cond show" data-show="v:SOURCE_MODE:local">
    <div class="br"><div class="f"><label>Bundle path (.tar.xz) <span class="hq" onclick="showHelp('MELUSINA_SANDSTORM_BUNDLE',event)">?</span></label><input data-k="MELUSINA_SANDSTORM_BUNDLE" placeholder="../sandstorm/sandstorm-0-fast.tar.xz"></div>
      <button class="brb" onclick="browse('MELUSINA_SANDSTORM_BUNDLE','.tar.xz,.tar')">Browse</button></div>
    <div class="h" style="font-size:.68rem;color:var(--dm);margin-top:4px">If empty the deploy script builds from the sandstorm/ directory.</div>
  </div>
</div>
</div>

<!-- 3. SERVICES -->
<div class="sec"><div class="sec-t">Services <span class="hq" onclick="showHelp('sec-services',event)">?</span></div>
<div class="sg" id="svc-grid">
  <div class="sv lock on" data-s="WATCHDOG"><div class="sv-i">üê∫</div><div class="sv-info"><div class="sv-n">Wolfdog <span class="hq" onclick="event.stopPropagation();showHelp('svc-WATCHDOG',event)">?</span></div><div class="sv-d">Monitoring &amp; health</div></div><span class="sv-tag r">Required</span><button class="sw on lock"></button></div>
  <div class="sv lock on" data-s="BACKUP"><div class="sv-i">üíæ</div><div class="sv-info"><div class="sv-n">Backup <span class="hq" onclick="event.stopPropagation();showHelp('svc-BACKUP',event)">?</span></div><div class="sv-d">Encrypted daily backups</div></div><span class="sv-tag r">Required</span><button class="sw on lock"></button></div>
  <div class="sv" data-s="MERMAIL" onclick="toggleSvc('MERMAIL')"><div class="sv-i">üìß</div><div class="sv-info"><div class="sv-n">MerMail <span class="hq" onclick="event.stopPropagation();showHelp('svc-MERMAIL',event)">?</span></div><div class="sv-d">Outbound email</div></div><span class="sv-tag o">Optional</span><button class="sw" id="sw-MERMAIL"></button></div>
  <div class="sv" data-s="AILAGOON" onclick="toggleSvc('AILAGOON')"><div class="sv-i">ü§ñ</div><div class="sv-info"><div class="sv-n">AiLagoon <span class="hq" onclick="event.stopPropagation();showHelp('svc-AILAGOON',event)">?</span></div><div class="sv-d">Local AI proxy</div></div><span class="sv-tag o">Optional</span><button class="sw" id="sw-AILAGOON"></button></div>
  <div class="sv" data-s="VINTAGE" onclick="toggleSvc('VINTAGE')"><div class="sv-i">üñ•Ô∏è</div><div class="sv-info"><div class="sv-n">Vintage <span class="hq" onclick="event.stopPropagation();showHelp('svc-VINTAGE',event)">?</span></div><div class="sv-d">Virtual desktop</div></div><span class="sv-tag o">Optional</span><button class="sw" id="sw-VINTAGE"></button></div>
  <div class="sv" data-s="SCREENING" onclick="toggleSvc('SCREENING')"><div class="sv-i">üîç</div><div class="sv-info"><div class="sv-n">TeleScreen <span class="hq" onclick="event.stopPropagation();showHelp('svc-SCREENING',event)">?</span></div><div class="sv-d">Sanctions &amp; reputation</div></div><span class="sv-tag o">Optional</span><button class="sw" id="sw-SCREENING"></button></div>
</div>
</div>

<!-- 4. DEPLOYMENT TOPOLOGY -->
<div class="sec"><div class="sec-t">Deployment Topology <span class="hq" onclick="showHelp('sec-topology',event)">?</span></div>
<div class="topo" id="topo">
  <div class="topo-h"><span>Click a node to set IPs &amp; SSH ¬∑ Drag sidecars between hosts</span></div>
  <div id="topo-vis"></div>
  <div class="t-add">
    <button onclick="addHost('local')">Ôºã Sidecar Host (Local) <span class="hq" onclick="event.stopPropagation();showHelp('topo-add-local',event)">?</span></button>
    <button onclick="addHost('remote')">Ôºã Sidecar Host (Remote) <span class="hq" onclick="event.stopPropagation();showHelp('topo-add-remote',event)">?</span></button>
  </div>
</div>
<div id="topo-cfg"></div>
</div>

<!-- 5. LICENSE & IDENTITY -->
<div class="sec" data-ez="hide"><div class="sec-t">License &amp; Identity <span class="hq" onclick="showHelp('sec-license',event)">?</span></div>
<div class="card">
  <div class="wbar">
    <button class="wb" data-w="phantom" onclick="connectW('phantom')">üëª Phantom</button>
    <button class="wb" data-w="solflare" onclick="connectW('solflare')">üîÜ Solflare</button>
    <button class="wb" data-w="backpack" onclick="connectW('backpack')">üéí Backpack</button>
    <span class="hq" onclick="showHelp('wallet-connect',event)">?</span>
    <span id="w-info" style="margin-left:auto;font-size:.74rem;color:var(--ac);font-family:monospace"></span>
    <button class="btn btn-s" id="w-dc" style="display:none;padding:4px 10px;font-size:.68rem" onclick="disconnectW()">Disconnect</button>
  </div>
  <div id="w-det" style="font-size:.65rem;color:var(--dm);padding:2px 0">
  </div>
  <div class="row">
    <div class="f"><label>Operator Wallet <span class="hq" onclick="showHelp('OPERATOR_WALLET',event)">?</span></label><input class="mono" data-k="OPERATOR_WALLET" placeholder="Solana pubkey"></div>
    <div class="f"><label>License NFT <span class="hq" onclick="showHelp('MELUSINA_LICENSE_NFT',event)">?</span></label><input class="mono" data-k="MELUSINA_LICENSE_NFT" placeholder="NFT mint address"></div>
  </div>
  <div class="f"><label>Keyholders <span class="hq" onclick="showHelp('SOLANA_KEYHOLDERS',event)">?</span></label><textarea data-k="SOLANA_KEYHOLDERS" placeholder="One per line or comma-separated" oninput="deriveKh()"></textarea></div>
  <div class="row">
    <div class="f"><label>Unseal Threshold <span class="hq" onclick="showHelp('UNSEAL_THRESHOLD',event)">?</span></label><input type="number" data-k="UNSEAL_THRESHOLD" placeholder="3" min="1" oninput="deriveKh()"></div>
    <div id="kh-info" style="display:flex;flex-direction:column;justify-content:end;padding-bottom:10px"></div>
  </div>
  <div style="margin-bottom:8px">
    <button class="brb" onclick="createSquadsMultisig()" style="padding:6px 14px;font-size:.72rem;font-weight:600">üîê Auto-Create Squads Multisig</button> <span class="hq" onclick="showHelp('btn-squads',event)">?</span>
    <div style="font-size:.62rem;color:var(--dm);margin-top:4px">Creates a Squads V4 multisig from your keyholders &amp; threshold above. Wallet must be connected.</div>
    <div id="squads-status" style="font-size:.7rem;margin-top:4px"></div>
  </div>
  <div class="row"><div class="f"><label>Multisig <span class="hq" onclick="showHelp('SQUADS_MULTISIG',event)">?</span></label><input class="mono" data-k="SQUADS_MULTISIG"></div><div class="f"><label>Vault <span class="hq" onclick="showHelp('SQUADS_VAULT',event)">?</span></label><input class="mono" data-k="SQUADS_VAULT"></div></div>
  <details style="margin-top:8px"><summary style="font-size:.68rem;color:var(--dm);cursor:pointer">‚öô Advanced / Admin <span class="hq" onclick="event.stopPropagation();showHelp('sec-advanced-admin',event)">?</span></summary>
    <div style="margin-top:6px">
      <div class="f"><label>Master NFT <span class="hq" onclick="showHelp('MASTER_NFT_MINT',event)">?</span></label><input class="mono" data-k="MASTER_NFT_MINT" placeholder="auto-filled"></div>
      <div class="row"><div class="f"><label>Program ID <span class="hq" onclick="showHelp('MELUSINA_PROGRAM_ID',event)">?</span></label><input data-k="MELUSINA_PROGRAM_ID" placeholder="auto-filled"></div><div class="f"><label>Governance ID <span class="hq" onclick="showHelp('MELUSINA_GOVERNANCE_ID',event)">?</span></label><input data-k="MELUSINA_GOVERNANCE_ID" placeholder="optional"></div></div>
      <div class="row"><div class="f"><label>Helius API Key <span class="hq" onclick="showHelp('HELIUS_API_KEY',event)">?</span></label><input data-k="HELIUS_API_KEY" placeholder="optional ‚Äì for mainnet RPC"></div><div class="f"><label>Helius RPC <span class="hq" onclick="showHelp('HELIUS_RPC',event)">?</span></label><input data-k="HELIUS_RPC" placeholder="optional ‚Äì defaults to public RPC"></div></div>
    </div>
  </details>
</div>
</div>

<!-- 6. OTP -->
<div class="sec" data-ez="hide"><div class="sec-t">OTP via Telegram <span class="hq" onclick="showHelp('sec-otp',event)">?</span></div>
<div class="card">
  <div class="tr"><div><div class="tr-l">Enable phone verification at signup <span class="hq" onclick="showHelp('OTP_ENABLED',event)">?</span></div><div class="tr-d">Users verify via Telegram Gateway before creating an account</div></div>
    <button class="tgl" id="tgl-otp" data-k="OTP_ENABLED" onclick="toggleK(this)"></button></div>
  <div class="cond" data-show="v:OTP_ENABLED:true">
    <div class="tr"><div><div class="tr-l">Enforce ‚Äî cannot skip <span class="hq" onclick="showHelp('OTP_ENFORCED',event)">?</span></div></div>
      <button class="tgl" id="tgl-otp2" data-k="OTP_ENFORCED" onclick="toggleK(this)"></button></div>
    <div class="f" style="margin-top:8px"><label>Telegram Gateway Token <span class="hq" onclick="showHelp('TELEGRAM_GATEWAY_TOKEN',event)">?</span></label><input data-k="TELEGRAM_GATEWAY_TOKEN"></div>
  </div>
</div>
</div>

<!-- 7. MERMAIL (conditional on MerMail service) -->
<div class="sec cond" data-ez="hide" data-show="svc:MERMAIL">
<div class="sec-t">MerMail <span class="hq" onclick="showHelp('sec-mermail',event)">?</span></div>
<div class="card">
  <div class="chs">
    <div class="ch on" data-r="EMAIL_PROVIDER" data-v="ses" onclick="pickR(this)">AWS SES</div>
    <div class="ch" data-r="EMAIL_PROVIDER" data-v="postmark" onclick="pickR(this)">Postmark</div>
    <div class="ch" data-r="EMAIL_PROVIDER" data-v="smtp" onclick="pickR(this)">SMTP</div>
    <span class="hq" onclick="showHelp('email-provider',event)">?</span>
  </div>
  <div class="cond show" data-show="v:EMAIL_PROVIDER:ses">
    <div class="row3"><div class="f"><label>Region <span class="hq" onclick="showHelp('AWS_SES_REGION',event)">?</span></label><input data-k="AWS_SES_REGION" placeholder="eu-central-1"></div><div class="f"><label>SMTP User <span class="hq" onclick="showHelp('AWS_SES_SMTP_USER',event)">?</span></label><input data-k="AWS_SES_SMTP_USER"></div><div class="f"><label>SMTP Pass <span class="hq" onclick="showHelp('AWS_SES_SMTP_PASS',event)">?</span></label><input type="password" data-k="AWS_SES_SMTP_PASS"></div></div>
  </div>
  <div class="cond" data-show="v:EMAIL_PROVIDER:postmark"><div class="f"><label>API Key <span class="hq" onclick="showHelp('POSTMARK_API_KEY',event)">?</span></label><input data-k="POSTMARK_API_KEY"></div></div>
  <div class="cond" data-show="v:EMAIL_PROVIDER:smtp">
    <div class="row"><div class="f"><label>Host <span class="hq" onclick="showHelp('SMTP_FALLBACK_HOST',event)">?</span></label><input data-k="SMTP_FALLBACK_HOST"></div><div class="f"><label>Port <span class="hq" onclick="showHelp('SMTP_FALLBACK_PORT',event)">?</span></label><input data-k="SMTP_FALLBACK_PORT" placeholder="587"></div></div>
    <div class="row"><div class="f"><label>User <span class="hq" onclick="showHelp('SMTP_FALLBACK_USER',event)">?</span></label><input data-k="SMTP_FALLBACK_USER"></div><div class="f"><label>Pass <span class="hq" onclick="showHelp('SMTP_FALLBACK_PASS',event)">?</span></label><input type="password" data-k="SMTP_FALLBACK_PASS"></div></div>
  </div>
  <div class="row" style="margin-top:8px"><div class="f"><label>DKIM Selector <span class="hq" onclick="showHelp('DKIM_SELECTOR',event)">?</span></label><input data-k="DKIM_SELECTOR" placeholder="melusina">
    <div class="h">Used for email signing ‚Äî default "melusina"</div></div>
    <div class="f"><label>Admin Token <span class="hq" onclick="showHelp('MERMAIL_ADMIN_TOKEN',event)">?</span></label><input data-k="MERMAIL_ADMIN_TOKEN" placeholder="(auto-generated if empty)">
    <div class="h">Token for Mermail admin API. Leave blank to auto-generate.</div></div></div>
</div>
</div>

<!-- 8. MONITORING -->
<div class="sec" data-ez="hide"><div class="sec-t">Monitoring <span class="hq" onclick="showHelp('sec-monitoring',event)">?</span></div>
<div class="card">
  <div class="row"><div class="f"><label>Watchdog Bot Token <span class="hq" onclick="showHelp('WATCHDOG_TG_TOKEN',event)">?</span></label><input data-k="WATCHDOG_TG_TOKEN" placeholder="Telegram bot token for Wolfdog alerts"></div><div class="f"><label>Chat ID <span class="hq" onclick="showHelp('WATCHDOG_TG_CHAT_ID',event)">?</span></label><input data-k="WATCHDOG_TG_CHAT_ID" placeholder="Telegram chat/group ID"></div></div>
  <div class="f"><label>Admin Telegram IDs <span class="hq" onclick="showHelp('WATCHDOG_TG_ADMINS',event)">?</span></label><input data-k="WATCHDOG_TG_ADMINS" placeholder="Comma-separated Telegram user IDs">
    <div class="h">Admins who can interact with the watchdog bot</div></div>
</div>
</div>

<!-- 9. ADVANCED -->
<div class="sec" data-ez="hide"><div class="sec-t">Advanced <span class="hq" onclick="showHelp('sec-advanced',event)">?</span></div>
<div class="card">
  <div class="tr"><div class="tr-l">Auto-boot on restart <span class="hq" onclick="showHelp('MELUSINA_AUTO_BOOT',event)">?</span></div><button class="tgl on" data-k="MELUSINA_AUTO_BOOT" onclick="toggleK(this)"></button></div>
  <div class="tr"><div class="tr-l">Auto-start sidecars <span class="hq" onclick="showHelp('MELUSINA_SIDECAR_AUTOSTART',event)">?</span></div><button class="tgl on" data-k="MELUSINA_SIDECAR_AUTOSTART" onclick="toggleK(this)"></button></div>
  <details><summary>WireGuard, timeouts, paths &amp; networking</summary>
    <div class="tr" style="margin-bottom:6px"><div><div class="tr-l">Auto-manage DNS records <span class="hq" onclick="showHelp('MANAGE_ZONE_DNS',event)">?</span></div><div class="tr-d">Let the deployer create DNS records in the parent zone (requires API access to your DNS provider)</div></div><button class="tgl" data-k="MANAGE_ZONE_DNS" onclick="toggleK(this)"></button></div>
    <div class="row3"><div class="f"><label>WG Port <span class="hq" onclick="showHelp('MELUSINA_WG_PORT',event)">?</span></label><input type="number" data-k="MELUSINA_WG_PORT" placeholder="51820"></div><div class="f"><label>WG Gateway IP <span class="hq" onclick="showHelp('MELUSINA_WG_AWS_IP',event)">?</span></label><input data-k="MELUSINA_WG_AWS_IP" placeholder="10.200.0.1"></div><div class="f"><label>WG VM IP <span class="hq" onclick="showHelp('MELUSINA_WG_VM_IP',event)">?</span></label><input data-k="MELUSINA_WG_VM_IP" placeholder="10.200.0.2"></div></div>
    <div class="row3"><div class="f"><label>Deploy Timeout <span class="hq" onclick="showHelp('MELUSINA_DEPLOY_TIMEOUT',event)">?</span></label><input type="number" data-k="MELUSINA_DEPLOY_TIMEOUT" placeholder="600"></div><div class="f"><label>Health Interval <span class="hq" onclick="showHelp('MELUSINA_HEALTH_INTERVAL',event)">?</span></label><input type="number" data-k="MELUSINA_HEALTH_INTERVAL" placeholder="30"></div><div class="f"><label>DNS TTL <span class="hq" onclick="showHelp('MELUSINA_DNS_TTL',event)">?</span></label><input type="number" data-k="MELUSINA_DNS_TTL" placeholder="300"></div></div>
    <div class="row"><div class="f"><label>MTU <span class="hq" onclick="showHelp('MELUSINA_MTU',event)">?</span></label><input type="number" data-k="MELUSINA_MTU" placeholder="1420"></div><div class="f"><label>Cert Email <span class="hq" onclick="showHelp('MELUSINA_CERT_EMAIL',event)">?</span></label><input data-k="MELUSINA_CERT_EMAIL"></div></div>
    <div class="row"><div class="f"><label>Log Dir <span class="hq" onclick="showHelp('MELUSINA_LOG_DIR',event)">?</span></label><input data-k="MELUSINA_LOG_DIR" placeholder="/var/log/melusina"></div><div class="f"><label>Backup Dir <span class="hq" onclick="showHelp('MELUSINA_BACKUP_DIR',event)">?</span></label><input data-k="MELUSINA_BACKUP_DIR" placeholder="/mnt/backups"></div></div>
  </details>
</div>
</div>

<!-- 10. GENERATE -->
<div class="sec"><div class="sec-t">Generate <span class="hq" onclick="showHelp('sec-generate',event)">?</span></div>
<div class="ebar">
  <button class="btn btn-p" onclick="generate()">‚ö° Generate .env</button> <span class="hq" onclick="showHelp('btn-generate',event)">?</span>
  <button class="btn btn-s" onclick="copyEnv()">üìã Copy</button>
  <button class="btn btn-s" onclick="dlEnv()">üíæ Download</button>
  <button class="btn btn-s" onclick="preflight()">üîç Preflight</button> <span class="hq" onclick="showHelp('btn-preflight',event)">?</span>
</div>
<ul class="cks" id="checks"></ul>
<pre id="env-out"></pre>
</div>

</div><!-- /.w-main -->
<div class="w-help">
  <div class="help-panel" id="help-panel">
    <div class="hp-title">Help</div>
    <div id="hp-content"><div class="hp-empty">Click any <span class="hq" style="pointer-events:none">?</span> to see an explanation.</div></div>
  </div>
</div>
</div><!-- /.w -->
<div id="toast"></div>


<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELP DICTIONARY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const HELP={
  // -- Section: Domain --
  'sec-domain':'<p>Pick a name for your Melusina instance. Your reseller provides the base domain ‚Äî you just choose the subdomain label.</p><p>Example: you type <code>myname</code> ‚Üí your instance lives at <code>myname.dev.pbay.app</code></p><p>This name is permanently baked into your license NFT on Solana.</p>',
  'MELUSINA_DOMAIN':'<p>Your subdomain label. This gets combined with the reseller\'s base domain to form your full URL.</p><p>Example: type <code>alice</code> ‚Üí <code>alice.dev.pbay.app</code></p><p><b>Rules:</b> lowercase letters, numbers, and hyphens. 3‚Äì63 characters. Must start and end with a letter or number.</p><p>Choose carefully ‚Äî this is written on-chain and can\'t be changed after purchase.</p>',
  'zone-sovereignty':'<p><b>No, it\'s a subdomain</b> ‚Äî Your reseller or hosting provider owns the parent domain (e.g. <code>app.theirsite.com</code>). They manage the DNS zone. Most common for buyers.</p><p><b>Yes, I own it</b> ‚Äî You registered this domain yourself (e.g. <code>mycompany.com</code>) and control its DNS zone at a registrar like Cloudflare, Namecheap, etc.</p>',
  'EXTRA_DNS':'<p>Additional DNS records to create in your zone. One per line.</p><p>Format: <code>name  type  value</code></p><p>Example:<br><code>mail A 1.2.3.4</code><br><code>_dmarc TXT "v=DMARC1; p=none"</code></p><p>Leave blank if you don\'t need extra records.</p>',

  // -- Section: Reseller & Network --
  'sec-reseller':'<p>Choose which Solana network to use and select the reseller who sold you a license.</p><p>Resellers are verified on-chain via NFTs ‚Äî pick yours from the list after fetching.</p>',
  'BLOCKCHAIN_NETWORK':'<p><b>Devnet</b> ‚Äî Solana test network. Free to use, no real money. Use this for testing and development.</p><p><b>Mainnet</b> ‚Äî Solana production network. Real SOL required. Use for production deployments.</p>',
  'reseller-list':'<p>The list of authorized resellers, fetched from the on-chain registry. Each reseller holds an NFT that proves they\'re authorized to sell Melusina licenses.</p><p>Click on your reseller to select them. If you bought directly from Melusina, pick the top-level reseller.</p>',

  // -- Section: Deploy Target --
  'sec-target':'<p>Where will the Melusina server actually run?</p>',
  'target-local':'<p><b>This Machine</b> ‚Äî Install and run everything on the computer you\'re using right now. No SSH or remote connections needed. Best for single-server setups or testing.</p>',
  'target-remote_from':'<p><b>Remote ‚Äî Deploy From Here</b> ‚Äî Your current machine is your workstation. The deploy script will SSH into a remote server and install Melusina there. You\'ll need the server\'s IP address and SSH credentials.</p>',
  'target-remote_on':'<p><b>Carry &amp; Install</b> ‚Äî Generate the .env file and package here, then physically transfer them to the target server (USB, scp, etc.) and run the installer on that machine. Good for air-gapped or restricted environments.</p>',

  // -- Section: Package Source --
  'sec-source':'<p>Where does the Melusina software package come from?</p>',
  'source-store':'<p><b>Download from Store</b> ‚Äî The deploy script will download the Melusina package from the on-chain app store. Your reseller\'s store URL is used. Requires internet access during install.</p>',
  'source-local':'<p><b>Local Bundle</b> ‚Äî Use a pre-downloaded <code>.tar.xz</code> package file. Point to the file path on disk. If left empty, the script will try to build from the local <code>sandstorm/</code> source directory.</p>',
  'MELUSINA_SANDSTORM_BUNDLE':'<p>Path to the Sandstorm application bundle file (<code>.tar.xz</code>).</p><p>If blank, the deploy script will attempt to build from the <code>sandstorm/</code> directory in your workspace. Only needed for "Local Bundle" mode.</p>',

  // -- Section: Services --
  'sec-services':'<p>Toggle optional sidecar services on or off. Required services (Wolfdog, Backup) cannot be disabled.</p>',
  'svc-WATCHDOG':'<p><b>Wolfdog</b> ‚Äî Health monitoring and alerting. Watches all services and sends Telegram notifications if anything goes down. <em>Required ‚Äî cannot be disabled.</em></p>',
  'svc-BACKUP':'<p><b>Backup</b> ‚Äî Automated encrypted daily backups. Stores snapshots so you can restore your instance. <em>Required ‚Äî cannot be disabled.</em></p>',
  'svc-MERMAIL':'<p><b>MerMail</b> ‚Äî Outbound email service. Lets your Melusina instance send emails (password resets, notifications, etc.) via AWS SES, Postmark, or generic SMTP.</p>',
  'svc-AILAGOON':'<p><b>AiLagoon</b> ‚Äî Local AI proxy. Routes AI requests through a local model (Ollama/LocalAI) so you don\'t need external API keys. Keeps data private.</p>',
  'svc-VINTAGE':'<p><b>Vintage</b> ‚Äî Virtual desktop environment. Provides a browser-accessible remote desktop for your users.</p>',
  'svc-SCREENING':'<p><b>TeleScreen</b> ‚Äî Sanctions and reputation screening. Checks users/transactions against sanctions lists and risk databases.</p>',

  // -- Section: Topology --
  'sec-topology':'<p>Visual map of your deployment. The gateway node handles incoming traffic. Sidecar hosts run optional services.</p><p><b>Click</b> a node to set its IP address and SSH key. <b>Drag</b> service pills between hosts to choose where each runs.</p>',
  'topo-add-local':'<p>Add a local sidecar host ‚Äî a machine on the same network as the gateway, reachable without SSH tunneling.</p>',
  'topo-add-remote':'<p>Add a remote sidecar host ‚Äî a machine at a different location, reachable via SSH over the internet.</p>',

  // -- Section: License & Identity --
  'sec-license':'<p>Blockchain identity for your deployment. Your Solana wallet proves ownership of a license NFT that authorizes running Melusina.</p>',
  'wallet-connect':'<p>Connect your Solana wallet (Phantom, Solflare, or Backpack) to interact with the license registry and optionally purchase a license or create a multisig.</p>',
  'OPERATOR_WALLET':'<p>The Solana public key (base58 address) of the wallet that will operate this deployment. This wallet\'s signature is checked during boot to prove you own the license.</p><p>Auto-filled when you connect a wallet above.</p>',
  'MELUSINA_LICENSE_NFT':'<p>The mint address of your license NFT. This is the specific edition NFT you received (or purchased) that grants you the right to run one Melusina instance.</p><p>Auto-filled after a successful purchase. If you already have one, paste the mint address.</p>',
  'SOLANA_KEYHOLDERS':'<p>Solana wallet addresses of all people who can participate in governance (unsealing, multisig votes, etc.).</p><p>Enter one wallet address per line, or comma-separated. These become members of your Squads multisig if you create one.</p>',
  'UNSEAL_THRESHOLD':'<p>Minimum number of keyholders required to unseal (unlock) the instance or approve multisig actions.</p><p>Example: If you have 5 keyholders and threshold is 3, any 3 of the 5 can approve. Must be ‚â§ total keyholders.</p>',
  'btn-squads':'<p>Automatically creates a Squads V4 multisig on Solana using the keyholders and threshold you entered above.</p><p>A multisig is a shared wallet requiring multiple signatures to authorize transactions ‚Äî used for team governance of your Melusina instance.</p><p>Your connected wallet must be one of the keyholders. The transaction costs a small fee in SOL.</p>',
  'SQUADS_MULTISIG':'<p>The on-chain address of your Squads V4 multisig account. Auto-filled when you click "Auto-Create Squads Multisig".</p><p>If you already have an existing Squads multisig, paste its address here instead.</p>',
  'SQUADS_VAULT':'<p>The vault (treasury) PDA of your Squads multisig. This is the address that holds funds and signs on behalf of the multisig.</p><p>Auto-derived from the multisig address. Don\'t change this unless you know what you\'re doing.</p>',

  // -- Advanced/Admin --
  'sec-advanced-admin':'<p>Internal system constants. Auto-populated with the correct values. Only change these if you\'re a developer or admin migrating to a different program.</p>',
  'MASTER_NFT_MINT':'<p>The mint address of the Melusina Master NFT. All license editions are printed from this master. Auto-filled ‚Äî do not change unless instructed.</p>',
  'MELUSINA_PROGRAM_ID':'<p>The Solana program ID (address) of the deployed Melusina license registry smart contract. Auto-filled.</p>',
  'MELUSINA_GOVERNANCE_ID':'<p>Optional SPL Governance program instance ID. Only needed if your deployment uses on-chain governance via Realms. Most deployments leave this blank.</p>',
  'HELIUS_API_KEY':'<p>API key for Helius (premium Solana RPC provider). Optional ‚Äî provides faster and more reliable RPC access on mainnet.</p><p>Leave blank to use the default public Solana RPC endpoint.</p>',
  'HELIUS_RPC':'<p>Full Helius RPC URL. Auto-derived from your API key if set. Leave blank to use the default public RPC for the selected network.</p>',

  // -- Section: OTP --
  'sec-otp':'<p>Phone verification via Telegram. When enabled, users must verify their phone number through Telegram Gateway before creating an account.</p>',
  'OTP_ENABLED':'<p>Toggle phone verification on or off. When ON, users see a phone verification step during signup.</p>',
  'OTP_ENFORCED':'<p>When ON, verification is <b>mandatory</b> ‚Äî users cannot skip it. When OFF, it\'s shown but users can choose to skip.</p>',
  'TELEGRAM_GATEWAY_TOKEN':'<p>Your Telegram Gateway API token. Get this from <a href="https://gateway.telegram.org" target="_blank" style="color:var(--ac)">gateway.telegram.org</a> by registering your bot. Required if OTP is enabled.</p>',

  // -- Section: MerMail --
  'sec-mermail':'<p>Email sending configuration. MerMail is the outbound email sidecar ‚Äî configure how it sends emails.</p>',
  'email-provider':'<p><b>AWS SES</b> ‚Äî Amazon Simple Email Service. Reliable, cheap, needs AWS credentials.<br><b>Postmark</b> ‚Äî Developer-friendly transactional email. Enter your API key.<br><b>SMTP</b> ‚Äî Generic SMTP server (any provider, self-hosted, etc.).</p>',
  'AWS_SES_REGION':'<p>AWS region where your SES is configured (e.g. <code>eu-central-1</code>, <code>us-east-1</code>). Must match your SES setup.</p>',
  'AWS_SES_SMTP_USER':'<p>SMTP username from your AWS SES credentials. Found in AWS Console ‚Üí SES ‚Üí SMTP Settings.</p>',
  'AWS_SES_SMTP_PASS':'<p>SMTP password from your AWS SES credentials. This is <b>not</b> your AWS password ‚Äî it\'s generated specifically for SES SMTP.</p>',
  'POSTMARK_API_KEY':'<p>Your Postmark server API token. Found in the Postmark dashboard under your server\'s settings.</p>',
  'SMTP_FALLBACK_HOST':'<p>Hostname of your SMTP server (e.g. <code>smtp.gmail.com</code>, <code>mail.yourdomain.com</code>).</p>',
  'SMTP_FALLBACK_PORT':'<p>SMTP port. Common values: <b>587</b> (STARTTLS, recommended), <b>465</b> (SSL), <b>25</b> (unencrypted, not recommended).</p>',
  'SMTP_FALLBACK_USER':'<p>Username for SMTP authentication. Usually your email address or a specific login.</p>',
  'SMTP_FALLBACK_PASS':'<p>Password for SMTP authentication.</p>',
  'DKIM_SELECTOR':'<p>DKIM selector for email signing. Default is <code>melusina</code>. Must match the DKIM DNS record you set up for your sending domain.</p><p>If you don\'t know what this is, leave the default.</p>',
  'MERMAIL_ADMIN_TOKEN':'<p>API token for MerMail\'s admin endpoints. Used by other services (like Wolfdog) to send emails through MerMail.</p><p>Leave blank to auto-generate a secure random token during deployment.</p>',

  // -- Section: Monitoring --
  'sec-monitoring':'<p>Wolfdog watchdog monitors all services and sends alerts via a Telegram bot when something goes wrong.</p>',
  'WATCHDOG_TG_TOKEN':'<p>Telegram Bot API token for alert notifications. Create a bot via <a href="https://t.me/BotFather" target="_blank" style="color:var(--ac)">@BotFather</a> and paste the token here.</p>',
  'WATCHDOG_TG_CHAT_ID':'<p>Telegram chat or group ID where alerts are sent. Use <a href="https://t.me/userinfobot" target="_blank" style="color:var(--ac)">@userinfobot</a> to find your chat ID, or add the bot to a group and get the group ID.</p>',
  'WATCHDOG_TG_ADMINS':'<p>Comma-separated list of Telegram user IDs who can send commands to the watchdog bot (restart services, acknowledge alerts, etc.).</p>',

  // -- Section: Advanced --
  'sec-advanced':'<p>System-level settings. The defaults work for most deployments. Only change these if you have specific infrastructure requirements.</p>',
  'MELUSINA_AUTO_BOOT':'<p>When ON, the Melusina instance starts automatically when the server reboots. Recommended for production.</p>',
  'MELUSINA_SIDECAR_AUTOSTART':'<p>When ON, all enabled sidecar services (MerMail, AiLagoon, etc.) start automatically alongside the main instance.</p>',
  'MANAGE_ZONE_DNS':'<p>When ON, the deploy script will automatically create and update DNS records via your DNS provider\'s API (Cloudflare, Route53, etc.).</p><p>When OFF, you must create the DNS records manually before deploying.</p>',
  'MELUSINA_WG_PORT':'<p>UDP port for WireGuard VPN tunnel between hosts. Default: <b>51820</b>. Change only if that port is already in use on your network.</p>',
  'MELUSINA_WG_AWS_IP':'<p>Internal WireGuard IP for the gateway node. Default: <code>10.200.0.1</code>. This is a private IP inside the VPN tunnel, not your public IP.</p>',
  'MELUSINA_WG_VM_IP':'<p>Internal WireGuard IP for the application VM. Default: <code>10.200.0.2</code>. Used for traffic routing inside the VPN.</p>',
  'MELUSINA_DEPLOY_TIMEOUT':'<p>Maximum time (in seconds) to wait for the deployment to complete. Default: <b>600</b> (10 minutes). Increase for slow connections or large packages.</p>',
  'MELUSINA_HEALTH_INTERVAL':'<p>How often (in seconds) Wolfdog checks service health. Default: <b>30</b>. Lower = faster alerts but more CPU usage.</p>',
  'MELUSINA_DNS_TTL':'<p>Time-to-live (in seconds) for DNS records. Default: <b>300</b> (5 minutes). Lower values mean DNS changes propagate faster but cause more DNS queries.</p>',
  'MELUSINA_MTU':'<p>Maximum Transmission Unit for WireGuard. Default: <b>1420</b>. Reduce if you see connectivity issues (some networks need 1380 or lower).</p>',
  'MELUSINA_CERT_EMAIL':'<p>Email address for Let\'s Encrypt TLS certificate. They\'ll email you if your cert is about to expire. Doesn\'t need to be a real inbox, but helps for alerts.</p>',
  'MELUSINA_LOG_DIR':'<p>Directory where all Melusina logs are stored. Default: <code>/var/log/melusina</code>.</p>',
  'MELUSINA_BACKUP_DIR':'<p>Directory for encrypted backups. Default: <code>/mnt/backups</code>. Must exist and be writable. Use a mounted volume for production.</p>',
  'MELUSINA_VM_NAME':'<p>Internal name for the Sandstorm VM instance. Default: <code>melusina</code>. Only change if running multiple instances on one host.</p>',

  // -- Section: Generate --
  'sec-generate':'<p>Generate the final <code>.env</code> file. Download it or copy to clipboard, then pass it to the deploy script.</p>',
  'btn-generate':'<p>Combines all your settings into a deployment <code>.env</code> file. This file is the <b>only input</b> the deploy script needs.</p>',
  'btn-copy':'<p>Copy the generated <code>.env</code> contents to your clipboard.</p>',
  'btn-download':'<p>Download the generated <code>.env</code> as a file you can transfer to the target server.</p>',
  'btn-preflight':'<p>Run validation checks against your configuration. Catches common mistakes (missing required fields, invalid addresses, threshold exceeding keyholder count, etc.) before you deploy.</p>',
  'btn-import':'<p>Import an existing <code>.env</code> file to pre-fill the configurator. Useful for editing a previous deployment\'s settings.</p>',
  'btn-reset':'<p>Clear all settings and start fresh. This resets everything to defaults.</p>',

  // -- Buy box --
  'buy-license':'<p>Purchase a Melusina license NFT on-chain. Costs 0.1 SOL on devnet. Your connected wallet pays, and a license edition NFT is minted to you automatically.</p><p>The license is tied to the domain you entered above.</p>',

  // -- Section: Install Mode --
  'sec-mode':'<p>Easy Mode walks you through the minimum steps: enter a domain, buy a license, pick sidecars, and review the deployment topology.</p><p>If any switch is <b>off</b>, Advanced Mode unlocks all configuration sections for experienced administrators.</p>',

  // -- Topology: Gateway & Server --
  'topo-gateway':'<p><b>Public Gateway</b> ‚Äî The edge server that faces the internet. It runs:</p><ul style="margin:6px 0 6px 16px;font-size:.74rem"><li><b>BIND9</b> ‚Äî authoritative DNS for your zone</li><li><b>nginx</b> ‚Äî SNI-based TLS passthrough proxy</li><li><b>WireGuard</b> ‚Äî encrypted VPN tunnel to the Melusina VM</li><li><b>certbot</b> ‚Äî automatic Let\'s Encrypt certificates</li></ul><p>Click the gateway node in the topology to set its public IP address and SSH credentials.</p>',
  'topo-server':'<p><b>Melusina Server</b> ‚Äî The application host running inside an Incus VM on the gateway. It runs:</p><ul style="margin:6px 0 6px 16px;font-size:.74rem"><li><b>Sandstorm</b> ‚Äî the grain-based app platform</li><li><b>Solana auth</b> ‚Äî on-chain license verification</li><li><b>Assigned sidecars</b> ‚Äî MerMail, AiLagoon, Vintage, etc.</li></ul><p>Click the server node in the topology to configure the VM name. The VM is created automatically by the deploy script ‚Äî no separate SSH access needed.</p>',
};

function showHelp(key,e){
  if(e){e.stopPropagation();e.preventDefault()}
  document.querySelectorAll('.hq.active').forEach(q=>q.classList.remove('active'));
  const btn=e?.currentTarget;if(btn)btn.classList.add('active');
  const ct=document.getElementById('hp-content');
  const txt=HELP[key];
  if(!txt){ct.innerHTML='<div class="hp-empty">No help available for this item.</div>';return}
  const label=key.replace(/^sec-|^svc-|^btn-|^target-|^source-/,'').replace(/[-_]/g,' ');
  ct.innerHTML=`<div class="hp-field">${label}</div><div class="hp-body">${txt}</div>`;
  // On mobile scroll panel into view
  if(window.innerWidth<=900)document.getElementById('help-panel').scrollIntoView({behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EASY / ADVANCED MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ezState=[true,true,true];
function toggleEz(i){
  ezState[i]=!ezState[i];
  document.getElementById('ez-'+i).classList.toggle('on',ezState[i]);
  updateMode();
}
function updateMode(){
  const easy=ezState.every(Boolean);
  const label=document.getElementById('mode-label');
  const hint=document.getElementById('mode-hint');
  if(label){
    if(easy){
      label.innerHTML='\ud83d\udfe2 Easy Mode';label.style.color='var(--gn)';
      hint.textContent='All switches on \u2014 only essential steps shown';
      // Default to local deploy in easy mode
      if(!S.v.DEPLOY_TARGET){S.v.DEPLOY_TARGET='local';pickTarget('local');save()}
    }else{
      label.innerHTML='\ud83d\udd27 Advanced Mode';label.style.color='var(--or)';
      hint.textContent='One or more switches off \u2014 all configuration sections visible';
    }
  }
  document.querySelectorAll('[data-ez="hide"]').forEach(el=>{
    el.classList.toggle('ez-hidden',easy);
  });
}

const K='mel_v8';
const SC=[
  {id:'WATCHDOG',name:'Wolfdog',icon:'üê∫',req:1},
  {id:'BACKUP',name:'Backup',icon:'üíæ',req:1,vm:1},
  {id:'MERMAIL',name:'MerMail',icon:'üìß'},
  {id:'AILAGOON',name:'AiLagoon',icon:'ü§ñ'},
  {id:'VINTAGE',name:'Vintage',icon:'üñ•Ô∏è'},
  {id:'SCREENING',name:'TeleScreen',icon:'üîç'},
];
let S,expandNode=null;
function fresh(){
  S={v:{DEPLOY_TARGET:'',SOURCE_MODE:'local',BLOCKCHAIN_NETWORK:'devnet',
    MELUSINA_ZONE_SOVEREIGNTY:'subdomain',EMAIL_PROVIDER:'ses',
    OTP_ENABLED:'false',OTP_ENFORCED:'false',MELUSINA_AUTO_BOOT:'true',
    MELUSINA_SIDECAR_AUTOSTART:'true',MANAGE_ZONE_DNS:'false',
    MELUSINA_VM_NAME:'melusina',RESELLER_NFT_MINT:'',RESELLER_NAME:'',
    MELUSINA_PROGRAM_ID:PROG_ID,MASTER_NFT_MINT:KNOWN_MASTER},
    dns:[],hosts:[],svc:{},sh:{}};
  SC.forEach(s=>{S.svc[s.id]=!!s.req;if(!s.vm)S.sh[s.id]='host'});
}
function save(){sessionStorage.setItem(K,JSON.stringify(S))}
function load(){
  try{const d=sessionStorage.getItem(K);if(d)S=JSON.parse(d);else{fresh();return}}catch(e){fresh();return}
  SC.forEach(s=>{if(s.req)S.svc[s.id]=true;if(!S.sh)S.sh={};if(!s.vm&&!S.sh[s.id])S.sh[s.id]='host'});
  if(!S.hosts)S.hosts=[];if(!S.dns)S.dns=[];
  // Auto-populate known on-chain constants so buyers never have to fill them
  if(!S.v.MELUSINA_PROGRAM_ID)S.v.MELUSINA_PROGRAM_ID=PROG_ID;
  if(!S.v.MASTER_NFT_MINT)S.v.MASTER_NFT_MINT=KNOWN_MASTER;
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VISIBILITY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function reflow(){
  document.querySelectorAll('.cond').forEach(el=>{
    const r=el.dataset.show;if(!r)return;
    if(r.startsWith('svc:')){el.classList.toggle('show',!!S.svc[r.slice(4)]);return}
    if(r.startsWith('target:')){const vs=r.slice(7).split('|');el.classList.toggle('show',vs.includes(S.v.DEPLOY_TARGET));return}
    if(r.startsWith('v:')){const[,k,v]=r.split(':');el.classList.toggle('show',S.v[k]===v);return}
  });
  document.querySelectorAll('.sv[data-s]').forEach(c=>{
    const id=c.dataset.s;c.classList.toggle('on',!!S.svc[id]);
    const sw=c.querySelector('.sw');if(sw)sw.classList.toggle('on',!!S.svc[id]);
  });
  updateStoreStatus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INPUTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindAll(){
  document.querySelectorAll('[data-k]').forEach(el=>{
    if(el._b)return;el._b=1;
    const k=el.dataset.k;
    if(el.tagName==='BUTTON')return;
    if(S.v[k]!==undefined&&S.v[k]!=='')el.value=S.v[k];
    const h=()=>{S.v[k]=el.value;save();reflow()};
    el.addEventListener('input',h);el.addEventListener('change',h);
  });
}
function pickR(el){
  el.parentElement.querySelectorAll('.ch').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');S.v[el.dataset.r]=el.dataset.v;save();reflow();
}
function pickTarget(t){
  document.querySelectorAll('.pk').forEach(b=>b.classList.toggle('on',b.dataset.t===t));
  S.v.DEPLOY_TARGET=t;save();reflow();topo();
}
function toggleSvc(id){
  const s=SC.find(x=>x.id===id);if(!s||s.req)return;
  S.svc[id]=!S.svc[id];if(!S.svc[id])S.sh[id]='host';
  save();reflow();topo();
}
function toggleK(btn){
  const k=btn.dataset.k;S.v[k]=S.v[k]==='true'?'false':'true';
  btn.classList.toggle('on',S.v[k]==='true');save();reflow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPOLOGY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Only container sidecars go in topology ‚Äî not BACKUP (it's a VM timer)
function enSc(){return SC.filter(s=>S.svc[s.id]&&!s.vm)}
function scOn(h){return enSc().filter(s=>S.sh[s.id]===h)}

function topo(){
  const box=document.getElementById('topo-vis');
  const gwIp=S.v.MELUSINA_AWS_IP||'';
  const srSc=scOn('host');
  let h='<div class="t-row">';
  h+=`<div class="t-n gw" onclick="xpand('gw')"><div class="t-i">üåê</div><div class="t-l">Public Gateway <span class="hq" onclick="event.stopPropagation();showHelp('topo-gateway',event)">?</span></div><div class="t-m">${esc(gwIp||'Click to set IP')}</div></div>`;
  h+=`<div class="t-link"><span class="t-link-tag">WireGuard</span></div>`;
  h+=`<div class="t-n sv" onclick="xpand('host')"><div class="t-i">üèóÔ∏è</div><div class="t-l">Melusina Server <span class="hq" onclick="event.stopPropagation();showHelp('topo-server',event)">?</span></div><div class="t-m">${srSc.length} service${srSc.length!==1?'s':''}</div>`;
  h+=pills('host',srSc);
  h+=`</div></div>`;
  if(S.hosts.length){
    h+='<div class="t-sc-row">';
    S.hosts.forEach(x=>{
      const hsc=scOn(x.id);
      h+=`<div class="t-n sc" style="position:relative" onclick="xpand('${x.id}')">
        <button class="t-rm" onclick="event.stopPropagation();rmHost('${x.id}')" title="Remove">‚úï</button>
        <div class="t-i">${x.conn==='remote'?'üåç':'üîó'}</div>
        <div class="t-l">Sidecar Host (${x.conn==='remote'?'Remote':'Local'})</div>
        <div class="t-m">${esc(x.ip||'No IP')} ¬∑ ${x.conn==='remote'?'WG':'LAN'} ¬∑ ${hsc.length} svc</div>`;
      h+=pills(x.id,hsc);
      h+=`</div>`;
    });
    h+='</div>';
  }
  box.innerHTML=h;
  cfgPanel();
}

function pills(hid,list){
  const hasMult=S.hosts.length>0;
  let h=`<div class="t-pills${hasMult?' drop':''}" ondragover="dOver(event,'${hid}')" ondragleave="dLeave(event)" ondrop="dDrop(event,'${hid}')">`;
  if(list.length)h+=list.map(s=>`<span class="pill" data-s="${s.id}" draggable="${!s.req}" ondragstart="dStart(event,'${s.id}')">${s.icon} ${s.name}</span>`).join('');
  else if(hasMult) h+=`<span style="color:var(--dm);font-size:.63rem">Drop services here</span>`;
  h+='</div>';return h;
}

let dragged=null;
function dStart(e,id){const s=SC.find(x=>x.id===id);if(s?.req){e.preventDefault();return}
  dragged=id;e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',id);
  requestAnimationFrame(()=>e.target.classList.add('dragging'))}
function dOver(e,h){e.preventDefault();e.dataTransfer.dropEffect='move';e.currentTarget.classList.add('drag-over')}
function dLeave(e){e.currentTarget.classList.remove('drag-over')}
function dDrop(e,h){e.preventDefault();e.currentTarget.classList.remove('drag-over');
  if(!dragged)return;S.sh[dragged]=h;save();topo();dragged=null}

function xpand(id){expandNode=expandNode===id?null:id;cfgPanel()}

function cfgPanel(){
  const box=document.getElementById('topo-cfg');
  if(!expandNode){box.innerHTML='';return}
  const id=expandNode;
  let h='<div class="cfg">';
  if(id==='gw'){
    h+=`<h4>üåê Public Gateway</h4>
      <div class="f"><label>Public IP</label><input data-k="MELUSINA_AWS_IP" value="${esc(S.v.MELUSINA_AWS_IP||'')}" placeholder="16.62.126.40"></div>
      <div class="h" style="font-size:.68rem;color:var(--dm);margin-top:-6px;margin-bottom:8px">Runs BIND9 DNS, nginx SNI passthrough, WireGuard endpoint, certbot.</div>`;
    if(S.v.DEPLOY_TARGET!=='local'){
      h+=`<div class="row"><div class="f"><label>SSH User</label><input data-k="MELUSINA_AWS_USER" value="${esc(S.v.MELUSINA_AWS_USER||'admin')}"></div>
        <div class="br"><div class="f"><label>SSH Key</label><input data-k="MELUSINA_AWS_KEY" value="${esc(S.v.MELUSINA_AWS_KEY||'')}"></div><button class="brb" onclick="browse('MELUSINA_AWS_KEY','.pem,.key')">Browse</button></div></div>`}
  }else if(id==='host'){
    h+=`<h4>üèóÔ∏è Melusina Server</h4>
      <p style="font-size:.72rem;color:var(--dm);margin-bottom:8px">Runs the Incus VM, Sandstorm, Solana auth, and all assigned services. Created on the gateway via <code>incus</code> ‚Äî no separate SSH needed.</p>`;
    h+=`<div class="f"><label>VM Name</label><input data-k="MELUSINA_VM_NAME" value="${esc(S.v.MELUSINA_VM_NAME||'melusina')}" placeholder="melusina">
      <div class="h" style="font-size:.65rem;color:var(--dm)">Incus VM name on the gateway machine</div></div>`;
  }else{
    const x=S.hosts.find(a=>a.id===id);if(!x){box.innerHTML='';return}
    h+=`<h4>${x.conn==='remote'?'üåç':'üîó'} Sidecar Host ‚Äî ${esc(x.id)}</h4>`;
    h+=`<div class="row"><div class="f"><label>IP</label><input data-h="${x.id}" data-hk="ip" value="${esc(x.ip||'')}"></div>
      <div class="f"><label>SSH User</label><input data-h="${x.id}" data-hk="ssh_user" value="${esc(x.ssh_user||'root')}"></div></div>
    <div class="br"><div class="f"><label>SSH Key</label><input data-h="${x.id}" data-hk="ssh_key" value="${esc(x.ssh_key||'')}"></div>
      <button class="brb" onclick="browseHK('${x.id}')">Browse</button></div>`;
    if(x.conn==='remote')h+=`<p style="font-size:.68rem;color:var(--dm);margin-top:8px">WireGuard tunnel to this host is auto-configured during deploy.</p>`;
  }
  h+='</div>';box.innerHTML=h;
  box.querySelectorAll('[data-k]').forEach(inp=>{
    inp.addEventListener('input',()=>{S.v[inp.dataset.k]=inp.value;save();topo()});
  });
  box.querySelectorAll('[data-h]').forEach(inp=>{
    inp.addEventListener('input',()=>{
      const x=S.hosts.find(a=>a.id===inp.dataset.h);if(x){x[inp.dataset.hk]=inp.value;save();topo()}
    });
  });
}

function addHost(conn){
  const n=S.hosts.filter(h=>h.conn===conn).length+1;
  S.hosts.push({id:(conn==='remote'?'remote':'local')+n,conn,ip:'',ssh_user:'root',ssh_key:''});
  save();topo();
}
function rmHost(id){
  S.hosts=S.hosts.filter(h=>h.id!==id);
  SC.forEach(s=>{if(S.sh[s.id]===id)S.sh[s.id]='host'});
  if(expandNode===id)expandNode=null;save();topo();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DNS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function deriveDns(){
  const d=(S.v.MELUSINA_DOMAIN||'').trim(),el=document.getElementById('dns-derived');
  if(!d||!d.includes('.')){el.innerHTML='';return}
  const p=d.split('.'),z=p.length>=3?p.slice(1).join('.'):d,pre=p.length>=3?p[0]:'@';
  el.innerHTML=`<div style="display:flex;gap:16px;margin-top:4px;font-size:.75rem"><span style="color:var(--dm)">Zone</span><span style="color:var(--gn);font-family:monospace">${z}</span><span style="color:var(--dm)">Sub</span><span style="color:var(--gn);font-family:monospace">${pre}</span><span style="color:var(--dm)">Wildcard</span><span style="color:var(--gn);font-family:monospace">*.${d}</span></div>`;
}
function parseDnsLines(){return(S.v.EXTRA_DNS||'').split('\n').map(l=>l.trim()).filter(Boolean).map(l=>{const p=l.split(/\s+/);return{name:p[0]||'',type:p[1]||'A',value:p.slice(2).join(' ')}})}
function deriveKh(){
  const raw=(S.v.SOLANA_KEYHOLDERS||'').replace(/\n/g,','),ws=raw.split(',').map(w=>w.trim()).filter(Boolean);
  const t=parseInt(S.v.UNSEAL_THRESHOLD||'3')||3,el=document.getElementById('kh-info');
  if(!ws.length){el.innerHTML='';return}
  S.v.TOTAL_KEYHOLDERS=String(ws.length);save();
  const ok=t<=ws.length;
  el.innerHTML=`<span style="font-size:.75rem;color:var(--dm)">${ws.length} detected ¬∑ threshold ${t}/${ws.length} <span style="color:${ok?'var(--gn)':'var(--rd)'}"> ${ok?'‚úì':'exceeds!'}</span></span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WALLET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cw=null;
function getWalletProvider(n){
  if(n==='phantom') return window.phantom?.solana||((window.solana?.isPhantom&&!window.solana?.isSolflare)?window.solana:null);
  if(n==='solflare'){
    // Solflare injects in multiple ways depending on version
    if(window.solflare&&typeof window.solflare.connect==='function') return window.solflare;
    if(window.Solflare&&typeof window.Solflare.connect==='function') return window.Solflare;
    if(window.solana?.isSolflare) return window.solana;
    return null;
  }
  if(n==='backpack') return window.backpack||window.xnft?.solana||null;
  return null;
}
function detectW(){const m={phantom:!!getWalletProvider('phantom'),solflare:!!getWalletProvider('solflare'),backpack:!!getWalletProvider('backpack')};
  document.querySelectorAll('.wb').forEach(b=>{b.classList.toggle('det',!!m[b.dataset.w])});
  const info=document.getElementById('w-det');
  if(info){const found=Object.entries(m).filter(([,v])=>v).map(([k])=>k);
    info.textContent=found.length?'Detected: '+found.join(', '):'No wallets detected ‚Äî install Phantom or Solflare extension'}
}
async function connectW(n){
  const p=getWalletProvider(n);
  if(!p){toast(n+' wallet not detected ‚Äî is the extension installed? Try refreshing the page.');return}
  try{
    let pub='';
    // Try connecting
    const r=await p.connect();
    // Different wallets put publicKey in different places
    const pk=r?.publicKey||p.publicKey||p.account?.publicKey;
    if(pk){
      pub=typeof pk.toBase58==='function'?pk.toBase58():(typeof pk.toString==='function'?pk.toString():'');
    }
    // Solflare sometimes needs a moment ‚Äî poll for publicKey
    if(!pub&&p.publicKey===null){
      for(let i=0;i<10;i++){
        await new Promise(r=>setTimeout(r,200));
        if(p.publicKey){pub=p.publicKey.toBase58?.()??p.publicKey.toString();break}
      }
    }
    if(!pub){
      console.error('Wallet connect debug:',{r,pPub:p.publicKey,pConnected:p.isConnected,pKeys:Object.keys(p)});
      throw new Error('Wallet connected but no public key returned. Try disconnecting in your wallet extension and reconnecting.');
    }
    cw={n,pub,p};
    document.getElementById('w-info').textContent=pub.slice(0,4)+'‚Ä¶'+pub.slice(-4);
    document.getElementById('w-dc').style.display='';
    document.querySelectorAll('.wb').forEach(b=>b.classList.toggle('on',b.dataset.w===n));
    const op=document.querySelector('[data-k="OPERATOR_WALLET"]');
    if(op&&!op.value){op.value=pub;S.v.OPERATOR_WALLET=pub;save()}
    toast('Connected: '+pub.slice(0,6)+'‚Ä¶');
    if(S.v.MELUSINA_DOMAIN)debounceLicenseCheck();
  }catch(e){toast('Failed: '+e.message);console.error('Wallet error:',e)}
}
async function autoConnect(){
  for(const n of['phantom','solflare','backpack']){
    const p=getWalletProvider(n);
    if(!p)continue;
    // Check if already connected
    const pk=p.publicKey;
    if(pk){
      const pub=pk.toBase58?.()??pk.toString();
      if(pub){cw={n,pub,p};return true}
    }
    // Try eager connect (won't show popup if previously approved)
    try{
      const r=await p.connect({onlyIfTrusted:true});
      const k=r?.publicKey||p.publicKey;
      if(k){const pub=k.toBase58?.()??k.toString();if(pub){cw={n,pub,p};return true}}
    }catch(e){/* not previously approved, skip */}
  }
  return false;
}
function disconnectW(){if(cw?.p?.disconnect)cw.p.disconnect();cw=null;
  document.getElementById('w-info').textContent='';document.getElementById('w-dc').style.display='none';
  document.querySelectorAll('.wb').forEach(b=>b.classList.remove('on'))}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BROWSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function browse(k,acc){
  if(window.showOpenFilePicker){try{const[fh]=await window.showOpenFilePicker({types:[{accept:{'*/*':acc?acc.split(','):['*']}}]});
    const f=await fh.getFile(),inp=document.querySelector(`[data-k="${k}"]`);if(inp){inp.value=f.name;S.v[k]=f.name;save()}}catch(e){if(e.name!=='AbortError')toast(e.message)}}
  else{const i=document.createElement('input');i.type='file';if(acc)i.accept=acc;i.onchange=()=>{const f=i.files[0];if(f){const t=document.querySelector(`[data-k="${k}"]`);if(t){t.value=f.name;S.v[k]=f.name;save()}}};i.click()}}
async function browseHK(hid){
  if(window.showOpenFilePicker){try{const[fh]=await window.showOpenFilePicker({types:[{accept:{'*/*':['.pem','.key']}}]});
    const f=await fh.getFile(),x=S.hosts.find(a=>a.id===hid);if(x){x.ssh_key=f.name;save();topo()}}catch(e){if(e.name!=='AbortError')toast(e.message)}}
  else toast('Type the path manually')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOLANA ON-CHAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROG_ID='BSENx6t1GVPzhnnd4yiojxWk7HjKZiiRQEkriHg6Mpix';
const KNOWN_MASTER='8kZ9GLytCBRyNqJjihnBsHK6c56DMjn6PAVdpegoR4bu';
const B58C='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
function b58d(s){const m=new Map();for(let i=0;i<58;i++)m.set(B58C[i],BigInt(i));let n=0n;for(const c of s)n=n*58n+(m.get(c)??0n);const b=[];while(n>0n){b.unshift(Number(n%256n));n/=256n}for(const c of s){if(c!=='1')break;b.unshift(0)}return new Uint8Array(b)}
function b58e(b){if(!b.length)return'';let n=0n;for(const x of b)n=n*256n+BigInt(x);const c=[];while(n>0n){c.unshift(B58C[Number(n%58n)]);n/=58n}for(const x of b){if(x)break;c.unshift('1')}return c.join('')}
const b64d=s=>Uint8Array.from(atob(s),c=>c.charCodeAt(0));
const b64e=b=>btoa(String.fromCharCode(...b));
function solUrl(){return S.v.HELIUS_RPC||(S.v.BLOCKCHAIN_NETWORK==='mainnet-beta'?'https://api.mainnet-beta.solana.com':'https://api.devnet.solana.com')}
async function solRpc(m,p){const r=await fetch(solUrl(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:m,params:p})});const j=await r.json();if(j.error)throw Error(j.error.message);return j.result}
const _dc={};async function disc(n){if(_dc[n])return _dc[n];const h=new Uint8Array(await crypto.subtle.digest('SHA-256',new TextEncoder().encode('account:'+n)));return _dc[n]=h.slice(0,8)}
function rS(d,o){const l=d[o]|(d[o+1]<<8)|(d[o+2]<<16)|(d[o+3]<<24);return{v:new TextDecoder().decode(d.slice(o+4,o+4+l)),e:o+4+l}}
function rP(d,o){return b58e(d.slice(o,o+32))}
function rU(d,o){let v=0;for(let i=7;i>=0;i--)v=v*256+d[o+i];return v}

// ‚îÄ‚îÄ License check (debounced on domain input) ‚îÄ‚îÄ
let _lt=null,_licData=null;
function debounceLicenseCheck(){clearTimeout(_lt);_lt=setTimeout(checkDomainLicense,800)}
async function checkDomainLicense(){
  const dom=(S.v.MELUSINA_DOMAIN||'').trim().toLowerCase(),el=document.getElementById('license-check');
  if(!dom||!dom.includes('.')){el.innerHTML='';_licData=null;return}
  el.innerHTML='<div style="color:var(--dm);font-size:.72rem;padding:4px 0">üîç Checking on-chain‚Ä¶</div>';
  try{
    const dc=await disc('LicenseEntry'),db=new TextEncoder().encode(dom);
    const lb=new Uint8Array([db.length&0xff,(db.length>>8)&0xff,0,0]);
    const fb=new Uint8Array([...lb,...db]);
    const res=await solRpc('getProgramAccounts',[PROG_ID,{encoding:'base64',filters:[
      {memcmp:{offset:0,bytes:b64e(dc),encoding:'base64'}},
      {memcmp:{offset:112,bytes:b64e(fb),encoding:'base64'}}]}]);
    if(!res||!res.length){_licData=null;
      const selR=_rl.find(r=>r.mint===S.v.RESELLER_NFT_MINT);
      const walletStatus=cw
        ?`<div style="font-size:.72rem;color:var(--gn);margin-bottom:6px">‚úì Wallet connected: <span class="mono">${cw.pub.slice(0,4)}‚Ä¶${cw.pub.slice(-4)}</span></div>`
        :`<div style="margin-bottom:8px"><div style="font-size:.68rem;color:var(--or);margin-bottom:4px">Connect your wallet to buy:</div><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="wb" onclick="connectW('phantom')">üëª Phantom</button><button class="wb" onclick="connectW('solflare')">üîÜ Solflare</button><button class="wb" onclick="connectW('backpack')">üéí Backpack</button></div></div>`;
      const buyInfo=selR&&selR.price>0
        ?`<div class="buy-box"><div class="buy-t">üí≥ Buy License for <span style="font-family:monospace;color:var(--tx)">${esc(dom)}</span></div>
           <div class="buy-d">${selR.baseDomain?'Subdomain permanently registered on Solana via':'License via'} <b>${esc(selR.name)}</b></div>
           <div class="buy-p">${(selR.price/1e9).toFixed(2)} SOL</div>
           ${walletStatus}
           <div id="edition-status" style="font-size:.68rem;color:var(--dm);margin-bottom:6px">Checking available editions‚Ä¶</div>
           <button class="buy-btn" onclick="purchaseLicense()"${cw?'':' disabled'}>üõí Buy <span style="font-family:monospace">${esc(dom)}</span> ‚Äî ${(selR.price/1e9).toFixed(2)} SOL</button>
           ${cw?'':'<div style="font-size:.62rem;color:var(--or);margin-top:4px">‚Üë Connect wallet first</div>'}</div>`
        :(!_rl.length?'<div style="font-size:.68rem;color:var(--dm);margin-top:4px">‚è≥ Loading resellers‚Ä¶</div>'
        :(S.v.RESELLER_NFT_MINT?'<div style="font-size:.68rem;color:var(--dm);margin-top:4px">Selected reseller has no price set</div>'
        :'<div style="font-size:.68rem;color:var(--dm);margin-top:4px">Select a reseller above to purchase</div>'));
      el.innerHTML=`<div style="padding:8px 12px;background:rgba(210,153,34,.06);border:1px solid var(--or);border-radius:8px;font-size:.72rem"><span style="color:var(--or)">‚ö† <b style="font-family:monospace">${esc(dom)}</b> ‚Äî no license found on ${esc(S.v.BLOCKCHAIN_NETWORK)}</span></div>${buyInfo}`;
      if(selR&&selR.price>0)updateEditionStatus();
      return}
    const d=b64d(res[0].account.data[0]),lm=rP(d,8),rm=rP(d,40),mm=rP(d,72),ed=rU(d,104);
    const dR=rS(d,112),iU=rS(d,dR.e),te=iU.e+32,thr=d[te];
    const st=d[te+1+32+1+32+32],stT=st===0?'Active':st===1?'Revoked':'?',stC=st===0?'var(--gn)':'var(--rd)',mmOk=mm===KNOWN_MASTER;
    _licData={status:stT,masterOk:mmOk,resellerName:'',licenseMint:lm,resellerMint:rm};
    if(!S.v.MELUSINA_LICENSE_NFT){S.v.MELUSINA_LICENSE_NFT=lm;const i=document.querySelector('[data-k="MELUSINA_LICENSE_NFT"]');if(i)i.value=lm;save()}
    el.innerHTML=`<div style="padding:10px 12px;background:${st===0?'rgba(63,185,80,.05)':'rgba(248,81,73,.05)'};border:1px solid ${stC};border-radius:8px;font-size:.72rem">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px"><b style="color:${stC}">${st===0?'‚úì License Found':'‚ö† License '+stT}</b><span style="color:${stC};font-weight:600">${stT}</span></div>
      <div style="display:grid;grid-template-columns:auto 1fr;gap:1px 12px;color:var(--dm)">
        <span>License</span><span class="mono" style="color:var(--tx);font-size:.68rem">${lm}</span>
        <span>Reseller</span><span class="mono" style="color:var(--tx);font-size:.68rem">${rm.slice(0,8)}‚Ä¶${rm.slice(-4)}</span>
        <span>Master NFT</span><span style="color:${mmOk?'var(--gn)':'var(--rd)'}"> ${mmOk?'‚úì Verified':'‚úó Mismatch!'}</span>
        <span>Edition</span><span>#${ed}</span><span>Threshold</span><span>${thr}</span></div></div>`;
    fetchResellerByMint(rm);
  }catch(e){_licData=null;el.innerHTML=`<div style="padding:8px 12px;background:rgba(248,81,73,.06);border:1px solid var(--rd);border-radius:8px;font-size:.72rem;color:var(--rd)">‚úó ${esc(e.message)}</div>`}
}

// ‚îÄ‚îÄ Reseller fetch & selection ‚îÄ‚îÄ
let _rl=[];
async function fetchResellers(){
  const el=document.getElementById('reseller-list');
  el.innerHTML='<div style="color:var(--dm);font-size:.72rem;padding:4px 0">üîç Fetching on '+esc(S.v.BLOCKCHAIN_NETWORK)+'‚Ä¶</div>';
  try{
    const dc=await disc('ResellerEntry');
    const res=await solRpc('getProgramAccounts',[PROG_ID,{encoding:'base64',filters:[
      {memcmp:{offset:0,bytes:b64e(dc),encoding:'base64'}}]}]);
    _rl=[];if(!res||!res.length){el.innerHTML='<div style="font-size:.72rem;color:var(--dm)">No resellers on '+esc(S.v.BLOCKCHAIN_NETWORK)+'</div>';return}
    for(const a of res){const d=b64d(a.account.data[0]);
      let o=8;const mint=rP(d,o);o+=32;const mm=rP(d,o);o+=32;o+=8;const owner=rP(d,o);o+=32;
      const nR=rS(d,o);o=nR.e;const tR=rS(d,o);o=tR.e;
      const lim=d[o]|(d[o+1]<<8)|(d[o+2]<<16)|(d[o+3]<<24);o+=4;
      const iss=d[o]|(d[o+1]<<8)|(d[o+2]<<16)|(d[o+3]<<24);o+=4;
      const hp=d[o];o+=1;if(hp)o+=32;o+=8;
      const hc=d[o];o+=1;let cat='';if(hc){const c=rS(d,o);cat=c.v;o=c.e}
      const status=d[o];o+=1;o+=8;const hasRev=d[o];o+=1;if(hasRev)o+=8;o+=1;
      const price=rU(d,o);o+=8;
      // base_domain: Option<String> (added in v3 migration)
      let baseDomain='';
      if(o<d.length){const bdTag=d[o];o+=1;if(bdTag===1){const bd=rS(d,o);baseDomain=bd.v;o=bd.e;}}
      if(status===0)_rl.push({mint,owner,name:nR.v,terr:tR.v,lim,iss,cat,top:!hp,mOk:mm===KNOWN_MASTER,price,baseDomain})}
    renderResellers();
  }catch(e){el.innerHTML=`<div style="font-size:.72rem;color:var(--rd)">‚úó ${esc(e.message)}</div>`}}

async function fetchResellerByMint(mint){
  try{const dc=await disc('ResellerEntry'),mb=b58d(mint),m32=mb.length>=32?mb.slice(mb.length-32):mb;
    const res=await solRpc('getProgramAccounts',[PROG_ID,{encoding:'base64',filters:[
      {memcmp:{offset:0,bytes:b64e(dc),encoding:'base64'}},{memcmp:{offset:8,bytes:b64e(m32),encoding:'base64'}}]}]);
    if(res?.length){const d=b64d(res[0].account.data[0]),nR=rS(d,112);
      S.v.RESELLER_NFT_MINT=mint;S.v.RESELLER_NAME=nR.v;save();
      if(_licData&&_licData.resellerMint===mint)_licData.resellerName=nR.v;
      renderResellers();updateStoreStatus()}}catch(e){}}

function renderResellers(){
  const el=document.getElementById('reseller-list');if(!el)return;
  if(!_rl.length&&!S.v.RESELLER_NAME){el.innerHTML='<div style="font-size:.72rem;color:var(--dm)">Click "Fetch Resellers" to load from chain</div>';return}
  if(!_rl.length&&S.v.RESELLER_NAME){el.innerHTML=`<div class="sv on" style="cursor:default"><div class="sv-i">üè™</div><div class="sv-info"><div class="sv-n">${esc(S.v.RESELLER_NAME)}</div><div class="sv-d">Selected reseller ¬∑ ${esc(S.v.RESELLER_NFT_MINT?.slice(0,8)||'')}‚Ä¶</div></div></div>`;return}
  let h='<div style="display:flex;flex-direction:column;gap:6px">';
  _rl.filter(r=>r.top).forEach(r=>{const s=S.v.RESELLER_NFT_MINT===r.mint,rem=r.lim-r.iss;
    const ps=r.price>0?`<b style="color:var(--gn)">${(r.price/1e9).toFixed(2)} SOL</b>`:'<span style="color:var(--dm)">No price</span>';
    const bd=r.baseDomain?`<span style="font-size:.58rem;color:var(--ac);margin-left:4px">üåê .${esc(r.baseDomain)}</span>`:'';
    h+=`<div class="sv${s?' on':''}" onclick="pickReseller('${r.mint}')" style="cursor:pointer"><div class="sv-i">üè™</div>
      <div class="sv-info"><div class="sv-n">${esc(r.name)}${bd}</div><div class="sv-d">${esc(r.terr)}${r.cat?' ¬∑ '+esc(r.cat):''} ¬∑ ${rem} remaining ¬∑ ${ps}</div></div>
      <span style="font-size:.6rem;color:${r.mOk?'var(--gn)':'var(--rd)'}">${r.mOk?'‚úì':'‚úó'} Master</span></div>`});
  const sub=_rl.filter(r=>!r.top);
  if(sub.length){h+=`<details style="margin-top:2px"><summary style="font-size:.68rem;color:var(--dm)">${sub.length} sub-reseller${sub.length>1?'s':''}</summary>`;
    sub.forEach(r=>{const s=S.v.RESELLER_NFT_MINT===r.mint;
      h+=`<div class="sv${s?' on':''}" onclick="pickReseller('${r.mint}')" style="cursor:pointer;margin-top:4px"><div class="sv-i">üè™</div>
        <div class="sv-info"><div class="sv-n">${esc(r.name)}</div><div class="sv-d">${esc(r.terr)}</div></div></div>`});
    h+='</details>'}
  h+='</div>';el.innerHTML=h}

function pickReseller(mint){const r=_rl.find(x=>x.mint===mint);
  S.v.RESELLER_NFT_MINT=mint;S.v.RESELLER_NAME=r?.name||'';save();renderResellers();updateStoreStatus();reflow();
  // Switch domain input mode based on base_domain
  updateDomainMode(r);
  if(S.v.MELUSINA_DOMAIN&&!_licData)debounceLicenseCheck()}

function getSelectedReseller(){return _rl.find(r=>r.mint===S.v.RESELLER_NFT_MINT)||null}

function updateDomainMode(r){
  const byod=document.getElementById('domain-byod'),hero=document.getElementById('domain-label-hero');
  const sovWrap=document.getElementById('zone-sov-wrap');
  const secTitle=document.querySelector('#domain-input-wrap')?.closest('.sec')?.querySelector('.sec-t');
  if(!byod||!hero)return;
  if(r&&r.baseDomain){
    // Label mode ‚Äî reseller provides base_domain
    byod.style.display='none';hero.style.display='block';
    document.getElementById('domain-suffix').textContent='.'+r.baseDomain;
    if(secTitle)secTitle.innerHTML='Choose Your Subdomain <span class="hq" onclick="showHelp(\'sec-domain\',event)">?</span>';
    // Hide sovereignty picker ‚Äî always "subdomain" in label mode
    if(sovWrap)sovWrap.style.display='none';
    S.v.MELUSINA_ZONE_SOVEREIGNTY='subdomain';
    // If we had a full domain from BYOD mode, try to extract the label
    const cur=(S.v.MELUSINA_DOMAIN||'').toLowerCase();
    const inp=document.getElementById('subdomain-label-input');
    if(cur.endsWith('.'+r.baseDomain)){inp.value=cur.replace('.'+r.baseDomain,'');}
    else if(!cur.includes('.')){inp.value=cur;} // looks like a label already
    else{inp.value='';}
    if(inp.value)onLabelInput(inp.value);
    updateDomainPreview(inp?.value||'');
  }else{
    // BYOD mode ‚Äî full domain input
    hero.style.display='none';byod.style.display='block';
    if(secTitle)secTitle.innerHTML='Deployment Domain <span class="hq" onclick="showHelp(\'sec-domain\',event)">?</span>';
    if(sovWrap)sovWrap.style.display='';
  }
}

function onLabelInput(val){
  val=val.toLowerCase().replace(/[^a-z0-9-]/g,'');
  const inp=document.getElementById('subdomain-label-input');
  if(inp&&inp.value!==val)inp.value=val;
  const r=getSelectedReseller();
  if(!r||!r.baseDomain)return;
  const fullDom=val?val+'.'+r.baseDomain:'';
  S.v.MELUSINA_DOMAIN=fullDom;
  // Also update the hidden data-k input so the main env export picks it up
  const mainInp=document.querySelector('[data-k="MELUSINA_DOMAIN"]');
  if(mainInp)mainInp.value=fullDom;
  updateDomainPreview(val);
  save();deriveDns();debounceLicenseCheck();
}

function updateDomainPreview(label){
  const el=document.getElementById('domain-preview');if(!el)return;
  const r=getSelectedReseller();
  if(!label||!r||!r.baseDomain){el.innerHTML='';return;}
  const ok=/^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$/.test(label);
  if(!ok&&label.length<3){el.innerHTML=`<span style="color:var(--dm)">Keep typing‚Ä¶</span>`;return;}
  if(!ok){el.innerHTML=`<span style="color:var(--rd)">‚úó Invalid label ‚Äî letters, numbers, hyphens. Must start and end with a letter or number.</span>`;return;}
  el.innerHTML=`<span style="color:var(--gn)">‚úì</span> <span style="color:var(--tx);font-family:monospace">${label}.${r.baseDomain}</span>`;
}

function updateStoreStatus(){const el=document.getElementById('store-status');if(!el)return;
  if(!S.v.RESELLER_NFT_MINT)el.innerHTML='<span style="color:var(--or)">‚ö† Select a reseller above first ‚Äî the store provides the latest verified tarball via your reseller</span>';
  else el.innerHTML=`<span style="color:var(--gn)">‚úì Latest bundle via <b>${esc(S.v.RESELLER_NAME)}</b> ‚Äî deploy script downloads automatically</span>`}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PURCHASE LICENSE (Simple ‚Äî no Squads) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const METADATA_PROG_ID='metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s';
const TOKEN_PROG_ID='TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';

// Pre-minted Print Editions available for purchase (edition #1 is the reseller)
const KNOWN_EDITIONS=[
  'HHpWETt3gUULTwKMDK4yZXXGcLr2h3HWDguFkUwixmpY',
  'HE7zWiV2zkYmLmuCRByYphg4uMiumBWdyrrwPCjds3RU',
  'JCqkWp13gHvY9sKz3jJzGsuxpo8uZPhiuqdNysW32sgY',
  '7BbtTTbzYKzKs3yTeF6qz5dRQcnU1p3CGDkYtsc5kkoL',
];
let _selectedEdition=null;

// Check which editions are still available (no license PDA exists yet)
async function findAvailableEdition(){
  const W3=window.solanaWeb3;if(!W3)return null;
  const prog=new W3.PublicKey(PROG_ID);
  const conn=new W3.Connection(solUrl());
  for(const mint of KNOWN_EDITIONS){
    const mintPk=new W3.PublicKey(mint);
    const [licensePda]=W3.PublicKey.findProgramAddressSync([new TextEncoder().encode('license'),mintPk.toBytes()],prog);
    const info=await conn.getAccountInfo(licensePda);
    if(!info){_selectedEdition=mint;return mint}
  }
  return null;
}

// Called after buy-box renders to show edition status
async function updateEditionStatus(){
  const el=document.getElementById('edition-status');if(!el)return;
  el.innerHTML='<span style="color:var(--dm)">‚è≥ Checking available editions‚Ä¶</span>';
  try{
    const ed=await findAvailableEdition();
    if(ed)el.innerHTML=`<span style="color:var(--gn)">‚úì Edition ready: ${ed.slice(0,6)}‚Ä¶${ed.slice(-4)}</span>`;
    else el.innerHTML='<span style="color:var(--rd)">‚úó No editions available ‚Äî contact reseller</span>';
  }catch(e){el.innerHTML=`<span style="color:var(--or)">‚ö† Could not check editions: ${esc(e.message)}</span>`}
}

async function purchaseLicense(){
  if(!cw){toast('Connecting wallet‚Ä¶');await autoConnect()}
  if(!cw){toast('Wallet not connected ‚Äî click Phantom or Solflare button above to connect, then try again');return}
  const dom=(S.v.MELUSINA_DOMAIN||'').trim().toLowerCase();
  if(!dom||!dom.includes('.')){toast('Enter a domain first');return}
  const resMint=S.v.RESELLER_NFT_MINT;
  if(!resMint){toast('Select a reseller first');return}

  const selR=_rl.find(r=>r.mint===resMint);
  if(!selR||!selR.price||selR.price===0){toast('Reseller has no price set');return}

  // Determine what to send as `domain` arg and what to hash
  // If reseller has base_domain ‚Üí domain arg = label only, hash = SHA-256(label.base_domain)
  // Otherwise ‚Üí domain arg = full FQDN, hash = SHA-256(full FQDN)
  let domainArg, fullDomForHash;
  if(selR.baseDomain){
    const label=dom.replace('.'+selR.baseDomain,'');
    if(!label||label.includes('.')){toast('Invalid subdomain label');return}
    domainArg=label;
    fullDomForHash=dom.replace(/\.$/,'').toLowerCase();
  }else{
    domainArg=dom.replace(/\.$/,'').toLowerCase();
    fullDomForHash=domainArg;
  }

  const el=document.getElementById('license-check');
  el.innerHTML+='<div style="color:var(--dm);font-size:.72rem;padding:4px 0;margin-top:4px">‚è≥ Finding available edition‚Ä¶</div>';

  try{
    const W3=window.solanaWeb3;if(!W3)throw Error('Solana web3.js not loaded');

    // Auto-find an available edition
    const licMint=_selectedEdition||await findAvailableEdition();
    if(!licMint)throw Error('No available license editions ‚Äî all are claimed. Contact the reseller.');

    const prog=new W3.PublicKey(PROG_ID);
    const masterMint=new W3.PublicKey(KNOWN_MASTER);
    const resMintPk=new W3.PublicKey(resMint);
    const licMintPk=new W3.PublicKey(licMint);
    const buyerPk=new W3.PublicKey(cw.pub);
    const resOwnerPk=new W3.PublicKey(selR.owner);
    const metaProg=new W3.PublicKey(METADATA_PROG_ID);
    const tokProg=new W3.PublicKey(TOKEN_PROG_ID);

    el.innerHTML+='<div style="color:var(--dm);font-size:.72rem;padding:2px 0">‚è≥ Building transaction (edition '+licMint.slice(0,8)+'‚Ä¶)‚Ä¶</div>';

    // Derive PDAs
    const _e=s=>new TextEncoder().encode(s);
    const [registryPda]=W3.PublicKey.findProgramAddressSync([_e('registry'),masterMint.toBytes()],prog);
    const [resellerPda]=W3.PublicKey.findProgramAddressSync([_e('reseller'),resMintPk.toBytes()],prog);
    const [licensePda]=W3.PublicKey.findProgramAddressSync([_e('license'),licMintPk.toBytes()],prog);
    const domHash=new Uint8Array(await crypto.subtle.digest('SHA-256',_e(fullDomForHash)));
    const [domClaimPda]=W3.PublicKey.findProgramAddressSync([_e('domain_claim'),domHash],prog);
    const [treasuryPda]=W3.PublicKey.findProgramAddressSync([_e('treasury'),masterMint.toBytes()],prog);
    const [masterEdPda]=W3.PublicKey.findProgramAddressSync(
      [_e('metadata'),metaProg.toBytes(),masterMint.toBytes(),_e('edition')],metaProg);
    const [licEdPda]=W3.PublicKey.findProgramAddressSync(
      [_e('metadata'),metaProg.toBytes(),licMintPk.toBytes(),_e('edition')],metaProg);

    // Anchor discriminator: SHA256("global:purchase_license_simple")[0..8]
    const discH=new Uint8Array(await crypto.subtle.digest('SHA-256',new TextEncoder().encode('global:purchase_license_simple')));
    const discrim=discH.slice(0,8);

    // Serialize instruction data (Borsh): domain, unlock_threshold, tls_cert_fingerprint, install_url, domain_hash
    const domB=new TextEncoder().encode(domainArg);
    const threshold=Math.min(Math.max(parseInt(S.v.UNSEAL_THRESHOLD||'3')||3,1),10);
    const instUrl=`https://admin.${fullDomForHash}`;
    const instB=new TextEncoder().encode(instUrl);
    const tlsFP=new Uint8Array(32);

    const dLen=8+4+domB.length+1+32+4+instB.length+32;
    const data=new Uint8Array(dLen);let p=0;
    data.set(discrim,p);p+=8;
    data[p]=domB.length&0xff;data[p+1]=(domB.length>>8)&0xff;data[p+2]=(domB.length>>16)&0xff;data[p+3]=(domB.length>>24)&0xff;p+=4;
    data.set(domB,p);p+=domB.length;
    data[p]=threshold;p+=1;
    data.set(tlsFP,p);p+=32;
    data[p]=instB.length&0xff;data[p+1]=(instB.length>>8)&0xff;data[p+2]=(instB.length>>16)&0xff;data[p+3]=(instB.length>>24)&0xff;p+=4;
    data.set(instB,p);p+=instB.length;
    data.set(domHash,p);p+=32;

    // Accounts: registry, reseller_entry, license_entry, domain_claim, buyer, reseller_owner,
    //           treasury, master_nft_mint, master_edition, license_nft_mint, license_edition,
    //           system_program, token_program
    const keys=[
      {pubkey:registryPda,isSigner:false,isWritable:true},
      {pubkey:resellerPda,isSigner:false,isWritable:true},
      {pubkey:licensePda,isSigner:false,isWritable:true},
      {pubkey:domClaimPda,isSigner:false,isWritable:true},
      {pubkey:buyerPk,isSigner:true,isWritable:true},
      {pubkey:resOwnerPk,isSigner:false,isWritable:true},
      {pubkey:treasuryPda,isSigner:false,isWritable:true},
      {pubkey:masterMint,isSigner:false,isWritable:false},
      {pubkey:masterEdPda,isSigner:false,isWritable:false},
      {pubkey:licMintPk,isSigner:false,isWritable:false},
      {pubkey:licEdPda,isSigner:false,isWritable:false},
      {pubkey:W3.SystemProgram.programId,isSigner:false,isWritable:false},
      {pubkey:tokProg,isSigner:false,isWritable:false},
    ];

    const ix=new W3.TransactionInstruction({programId:prog,keys,data});
    const conn=new W3.Connection(solUrl());
    const {blockhash}=await conn.getLatestBlockhash();
    const tx=new W3.Transaction({recentBlockhash:blockhash,feePayer:buyerPk});
    tx.add(ix);

    el.innerHTML+='<div style="color:var(--dm);font-size:.72rem;padding:2px 0">‚è≥ Waiting for wallet signature‚Ä¶</div>';
    const signed=await cw.p.signTransaction(tx);
    const sig=await conn.sendRawTransaction(signed.serialize());
    el.innerHTML+='<div style="color:var(--dm);font-size:.72rem;padding:2px 0">‚è≥ Confirming transaction‚Ä¶</div>';
    await conn.confirmTransaction(sig,'confirmed');

    toast('‚úÖ License purchased! TX: '+sig.slice(0,12)+'‚Ä¶');
    S.v.MELUSINA_LICENSE_NFT=licMint;
    const fi=document.querySelector('[data-k="MELUSINA_LICENSE_NFT"]');if(fi)fi.value=licMint;
    save();
    setTimeout(()=>checkDomainLicense(),2000);
  }catch(e){
    toast('Purchase failed: '+e.message);
    console.error('Purchase error:',e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTO-CREATE SQUADS MULTISIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SQUADS_PROG_ID='SQDS4ep65T869zMMBKyuUq6aD6EgTu8psMjkvj52pCf';

async function createSquadsMultisig(){
  const el=document.getElementById('squads-status');
  if(!cw){
    if(el)el.innerHTML='<span style="color:var(--dm)">‚è≥ Connecting wallet‚Ä¶</span>';
    await autoConnect();
    if(!cw){
      // Show inline wallet buttons
      if(el)el.innerHTML=`<div style="margin:6px 0"><span style="color:var(--or);font-size:.72rem">Connect wallet first:</span><div style="display:flex;gap:6px;margin-top:4px"><button class="wb" onclick="connectW('phantom').then(()=>createSquadsMultisig())">üëª Phantom</button><button class="wb" onclick="connectW('solflare').then(()=>createSquadsMultisig())">üîÜ Solflare</button></div></div>`;
      return;
    }
  }

  const kh=(S.v.SOLANA_KEYHOLDERS||'').replace(/\n/g,',').split(',').map(w=>w.trim()).filter(Boolean);
  const thr=Math.max(parseInt(S.v.UNSEAL_THRESHOLD||'2')||2,1);

  // Always include the connected wallet as a member
  const memberSet=new Set(kh);
  memberSet.add(cw.pub);
  const members=[...memberSet];

  if(members.length<1){toast('Add keyholders first');if(el)el.innerHTML='<span style="color:var(--or)">‚ö† Add keyholders in the field above</span>';return}
  if(thr>members.length){toast('Threshold ('+thr+') exceeds member count ('+members.length+')');return}

  if(el)el.innerHTML='<span style="color:var(--dm)">‚è≥ Creating Squads V4 multisig ('+members.length+' members, threshold '+thr+')‚Ä¶</span>';

  try{
    const W3=window.solanaWeb3;if(!W3)throw Error('Solana web3.js not loaded');
    const _e=s=>new TextEncoder().encode(s);
    const conn=new W3.Connection(solUrl());
    const squadsProg=new W3.PublicKey(SQUADS_PROG_ID);
    const buyerPk=new W3.PublicKey(cw.pub);

    // Generate a random create_key for the multisig
    const createKey=W3.Keypair.generate();

    // Derive program_config PDA: seeds = ["multisig", "program_config"]
    const [programConfigPda]=W3.PublicKey.findProgramAddressSync(
      [_e('multisig'),_e('program_config')],squadsProg);

    // Fetch program_config to get treasury address (offset: 8 disc + 32 authority + 8 fee = 48)
    const cfgAcct=await conn.getAccountInfo(programConfigPda);
    if(!cfgAcct)throw Error('Squads program_config not found on this cluster');
    const treasuryPk=new W3.PublicKey(cfgAcct.data.slice(48,80));

    // Derive multisig PDA: seeds = ["multisig", "multisig", create_key]
    const [multisigPda]=W3.PublicKey.findProgramAddressSync(
      [_e('multisig'),_e('multisig'),createKey.publicKey.toBytes()],squadsProg);

    // Derive vault PDA: seeds = ["multisig", "vault", multisig_pda, u8(0)]
    const [vaultPda]=W3.PublicKey.findProgramAddressSync(
      [_e('multisig'),_e('vault'),multisigPda.toBytes(),new Uint8Array([0])],squadsProg);

    // Build multisig_create_v2 instruction
    // Discriminator: SHA256("global:multisig_create_v2")[0..8]
    const discH=new Uint8Array(await crypto.subtle.digest('SHA-256',_e('global:multisig_create_v2')));
    const disc=discH.slice(0,8);

    // Sort members by pubkey bytes (Squads V4 requirement)
    const sortedMembers=members.map(m=>new W3.PublicKey(m)).sort((a,b)=>{
      const ab=a.toBytes(),bb=b.toBytes();
      for(let i=0;i<32;i++){if(ab[i]!==bb[i])return ab[i]-bb[i]}return 0;
    });

    // Serialize args: MultisigCreateArgsV2 {
    //   config_authority: Option<Pubkey>,  threshold: u16,
    //   members: Vec<Member>,  time_lock: u32,
    //   rent_collector: Option<Pubkey>,  memo: Option<String>
    // }
    // Member = { key: Pubkey(32), permissions: Permissions { mask: u8 } } = 33 bytes
    const memberBytes=new Uint8Array(4+sortedMembers.length*33);
    memberBytes[0]=sortedMembers.length&0xff;memberBytes[1]=(sortedMembers.length>>8)&0xff;
    memberBytes[2]=(sortedMembers.length>>16)&0xff;memberBytes[3]=(sortedMembers.length>>24)&0xff;
    sortedMembers.forEach((pk,i)=>{
      memberBytes.set(pk.toBytes(),4+i*33);
      memberBytes[4+i*33+32]=7; // Permissions mask: Initiate(1)|Vote(2)|Execute(4) = 7
    });

    // config_authority=None, threshold=u16, members, time_lock=0, rent_collector=None, memo=None
    const dLen=8+1+2+memberBytes.length+4+1+1;
    const data=new Uint8Array(dLen);let p=0;
    data.set(disc,p);p+=8;
    data[p]=0;p+=1; // config_authority = None
    data[p]=thr&0xff;data[p+1]=(thr>>8)&0xff;p+=2; // threshold u16 LE
    data.set(memberBytes,p);p+=memberBytes.length; // members vec
    data[p]=0;data[p+1]=0;data[p+2]=0;data[p+3]=0;p+=4; // time_lock = 0 (u32 LE)
    data[p]=0;p+=1; // rent_collector = None
    data[p]=0;p+=1; // memo = None

    // Accounts for MultisigCreateV2 (order matters!):
    // 1. program_config (PDA, not writable)
    // 2. treasury (writable)
    // 3. multisig (writable, init PDA)
    // 4. create_key (signer, seed)
    // 5. creator (signer, payer, mut)
    // 6. system_program
    const keys=[
      {pubkey:programConfigPda,isSigner:false,isWritable:false},
      {pubkey:treasuryPk,isSigner:false,isWritable:true},
      {pubkey:multisigPda,isSigner:false,isWritable:true},
      {pubkey:createKey.publicKey,isSigner:true,isWritable:false},
      {pubkey:buyerPk,isSigner:true,isWritable:true},
      {pubkey:W3.SystemProgram.programId,isSigner:false,isWritable:false},
    ];

    const ix=new W3.TransactionInstruction({programId:squadsProg,keys,data});
    const {blockhash}=await conn.getLatestBlockhash();
    const tx=new W3.Transaction({recentBlockhash:blockhash,feePayer:buyerPk});
    tx.add(ix);
    tx.partialSign(createKey); // create_key must sign

    if(el)el.innerHTML='<span style="color:var(--dm)">‚è≥ Approve in your wallet‚Ä¶</span>';
    const signed=await cw.p.signTransaction(tx);
    const sig=await conn.sendRawTransaction(signed.serialize());
    if(el)el.innerHTML='<span style="color:var(--dm)">‚è≥ Confirming‚Ä¶</span>';
    await conn.confirmTransaction(sig,'confirmed');

    // Fill in the fields
    const msAddr=multisigPda.toBase58();
    const vAddr=vaultPda.toBase58();
    S.v.SQUADS_MULTISIG=msAddr;S.v.SQUADS_VAULT=vAddr;
    const msEl=document.querySelector('[data-k="SQUADS_MULTISIG"]');if(msEl)msEl.value=msAddr;
    const vEl=document.querySelector('[data-k="SQUADS_VAULT"]');if(vEl)vEl.value=vAddr;
    save();

    if(el)el.innerHTML=`<span style="color:var(--gn)">‚úì Multisig created!</span><br>
      <span class="mono" style="font-size:.62rem">${msAddr}</span><br>
      <span style="font-size:.62rem;color:var(--dm)">Vault: <span class="mono">${vAddr}</span></span>`;
    toast('‚úÖ Squads multisig created!');
  }catch(e){
    if(el)el.innerHTML=`<span style="color:var(--rd)">‚úó ${esc(e.message)}</span>`;
    toast('Squads creation failed: '+e.message);
    console.error('Squads create error:',e);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PREFLIGHT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function preflight(){
  const v=S.v,c=[],wR=/^[1-9A-HJ-NP-Za-km-z]{32,44}$/;
  const kh=(v.SOLANA_KEYHOLDERS||'').replace(/\n/g,',').split(',').map(w=>w.trim()).filter(Boolean);
  const th=parseInt(v.UNSEAL_THRESHOLD||'3')||3;
  c.push({l:'Domain',p:!!v.MELUSINA_DOMAIN});
  if(v.MELUSINA_DOMAIN)c.push({l:'Domain format',p:/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(v.MELUSINA_DOMAIN)});
  c.push({l:'Reseller selected',p:!!v.RESELLER_NFT_MINT});
  c.push({l:'Deploy mode chosen',p:!!v.DEPLOY_TARGET});
  c.push({l:'Gateway IP',p:!!v.MELUSINA_AWS_IP});
  if(v.DEPLOY_TARGET==='remote_from')c.push({l:'SSH key',p:!!v.MELUSINA_AWS_KEY});
  c.push({l:'VM Name',p:!!v.MELUSINA_VM_NAME});
  c.push({l:'Operator wallet',p:!!v.OPERATOR_WALLET});
  if(v.OPERATOR_WALLET)c.push({l:'Operator format',p:wR.test(v.OPERATOR_WALLET)});
  c.push({l:'License NFT',p:!!v.MELUSINA_LICENSE_NFT});
  if(v.MELUSINA_LICENSE_NFT)c.push({l:'License NFT format',p:wR.test(v.MELUSINA_LICENSE_NFT)});
  c.push({l:'Keyholders',p:kh.length>0});
  if(kh.length){c.push({l:`Threshold ${th}‚â§${kh.length}`,p:th<=kh.length});kh.forEach((a,i)=>c.push({l:`KH ${i+1} format`,p:wR.test(a)}))}
  if(v.OTP_ENABLED==='true')c.push({l:'TG Gateway token',p:!!v.TELEGRAM_GATEWAY_TOKEN});
  if(S.svc.MERMAIL){const pr=v.EMAIL_PROVIDER;if(pr==='ses')c.push({l:'SES region',p:!!v.AWS_SES_REGION});else if(pr==='postmark')c.push({l:'Postmark key',p:!!v.POSTMARK_API_KEY});else if(pr==='smtp')c.push({l:'SMTP host',p:!!v.SMTP_FALLBACK_HOST})}
  c.push({l:'Watchdog bot token',p:!!v.WATCHDOG_TG_TOKEN});
  c.push({l:'Watchdog chat ID',p:!!v.WATCHDOG_TG_CHAT_ID});
  S.hosts.forEach(x=>{c.push({l:`Host ${x.id} IP`,p:!!x.ip})});
  if(_licData){c.push({l:'License on-chain: '+(_licData.status||'?'),p:_licData.status==='Active'});
    c.push({l:'Master NFT lineage',p:_licData.masterOk});
    if(_licData.resellerName)c.push({l:'Reseller: '+_licData.resellerName,p:true})}
  const ul=document.getElementById('checks');ul.innerHTML='';
  const ok=c.filter(x=>x.p).length;
  const hd=document.createElement('li');hd.style.fontWeight='600';hd.innerHTML=`<div class="ck ${ok===c.length?'p':'f'}">${ok===c.length?'‚úì':'!'}</div><span>${ok}/${c.length}</span>`;ul.appendChild(hd);
  c.forEach(x=>{const li=document.createElement('li');li.innerHTML=`<div class="ck ${x.p?'p':'f'}">${x.p?'‚úì':'‚úó'}</div><span>${x.l}</span>`;ul.appendChild(li)});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GENERATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generate(){
  preflight();const v=S.v,L=[];
  const sec=(h,a)=>{L.push('');L.push('# '+h);a.filter(Boolean).forEach(x=>L.push(x))};
  const dom=v.MELUSINA_DOMAIN||'';
  const zoneDom=dom.split('.').length>=3?dom.split('.').slice(1).join('.'):dom;
  L.push('# Melusina deployment.env ‚Äî '+new Date().toISOString());

  sec('Domain & Infrastructure',[
    `MELUSINA_DOMAIN="${dom}"`,
    `MELUSINA_ZONE_SOVEREIGNTY="${v.MELUSINA_ZONE_SOVEREIGNTY||'subdomain'}"`,
    v.MANAGE_ZONE_DNS==='true'?'MANAGE_ZONE_DNS="true"':null,
    `MELUSINA_AWS_IP="${v.MELUSINA_AWS_IP||''}"`,
    v.MELUSINA_AWS_USER?`MELUSINA_AWS_USER="${v.MELUSINA_AWS_USER}"`:null,
    v.MELUSINA_AWS_KEY?`MELUSINA_AWS_KEY="${v.MELUSINA_AWS_KEY}"`:null,
    `MELUSINA_VM_NAME="${v.MELUSINA_VM_NAME||'melusina'}"`
  ]);

  const dnsL=parseDnsLines();if(dnsL.length){sec('Extra DNS',[]); dnsL.forEach((e,i)=>{L.push(`EXTRA_DNS_${i+1}_NAME="${e.name}"`,`EXTRA_DNS_${i+1}_TYPE="${e.type}"`,`EXTRA_DNS_${i+1}_VALUE="${e.value}"`)})}

  sec('WireGuard',[
    `MELUSINA_WG_PORT="${v.MELUSINA_WG_PORT||'51820'}"`,
    `MELUSINA_WG_AWS_IP="${v.MELUSINA_WG_AWS_IP||'10.200.0.1'}"`,
    `MELUSINA_WG_VM_IP="${v.MELUSINA_WG_VM_IP||'10.200.0.2'}"`
  ]);

  sec('Sandstorm',[`SOURCE_MODE="${v.SOURCE_MODE||'local'}"`,
    v.MELUSINA_SANDSTORM_BUNDLE?`MELUSINA_SANDSTORM_BUNDLE="${v.MELUSINA_SANDSTORM_BUNDLE}"`:null]);

  sec('Blockchain & License',[
    `BLOCKCHAIN_NETWORK="${v.BLOCKCHAIN_NETWORK||'devnet'}"`,
    `MELUSINA_LICENSE_NFT="${v.MELUSINA_LICENSE_NFT||''}"`,
    `MELUSINA_PROGRAM_ID="${v.MELUSINA_PROGRAM_ID||''}"`,
    v.RESELLER_NFT_MINT?`RESELLER_NFT_MINT="${v.RESELLER_NFT_MINT}"`:null,
    v.MASTER_NFT_MINT?`MASTER_NFT_MINT="${v.MASTER_NFT_MINT}"`:null,
    v.MELUSINA_GOVERNANCE_ID?`MELUSINA_GOVERNANCE_ID="${v.MELUSINA_GOVERNANCE_ID}"`:null,
    v.SQUADS_MULTISIG?`SQUADS_MULTISIG="${v.SQUADS_MULTISIG}"`:null,
    v.SQUADS_VAULT?`SQUADS_VAULT="${v.SQUADS_VAULT}"`:null,
    v.ADMIN_WALLET?`ADMIN_WALLET="${v.ADMIN_WALLET}"`:null,
    v.HELIUS_API_KEY?`HELIUS_API_KEY="${v.HELIUS_API_KEY}"`:null,
    v.HELIUS_RPC?`HELIUS_RPC="${v.HELIUS_RPC}"`:null
  ]);

  sec('Identity & Keyholders',[
    `OPERATOR_WALLET="${v.OPERATOR_WALLET||''}"`,
    `SOLANA_KEYHOLDERS="${(v.SOLANA_KEYHOLDERS||'').replace(/\n/g,',')}"`,
    `UNSEAL_THRESHOLD="${v.UNSEAL_THRESHOLD||'3'}"`,
    `TOTAL_KEYHOLDERS="${v.TOTAL_KEYHOLDERS||'0'}"`
  ]);

  if(v.OTP_ENABLED==='true')sec('OTP',[`TELEGRAM_GATEWAY_TOKEN="${v.TELEGRAM_GATEWAY_TOKEN||''}"`,v.OTP_ENFORCED==='true'?'OTP_ENFORCE_SIGNUP="true"':null]);

  const en=SC.filter(s=>S.svc[s.id]&&!s.vm),ah=['host',...S.hosts.map(h=>h.id)];
  sec('Sidecar Configuration',[
    `SIDECAR_HOSTS="${ah.join(',')}"`,
    'BACKUP_ENABLED="true"',
    ...en.map(s=>`SIDECAR_HOST_${s.id}="${S.sh[s.id]||'host'}"`)
  ]);

  S.hosts.forEach(x=>{const p='SIDECAR_'+x.id.toUpperCase()+'_';
    sec('Host '+x.id,[`${p}IP="${x.ip||''}"`,`${p}SSH_USER="${x.ssh_user||'root'}"`,`${p}SSH_KEY="${x.ssh_key||''}"`])});

  if(S.svc.MERMAIL){
    const pr=v.EMAIL_PROVIDER||'ses';
    const fromAddr='noreply@'+zoneDom;
    sec('MerMail ‚Äî Email Delivery',[`EMAIL_PROVIDER="${pr}"`]);
    if(pr==='ses')L.push(`AWS_SES_REGION="${v.AWS_SES_REGION||''}"`,`AWS_SES_SMTP_USER="${v.AWS_SES_SMTP_USER||''}"`,`AWS_SES_SMTP_PASS="${v.AWS_SES_SMTP_PASS||''}"`,`AWS_SES_FROM="${fromAddr}"`);
    else if(pr==='postmark')L.push(`POSTMARK_API_KEY="${v.POSTMARK_API_KEY||''}"`,`POSTMARK_FROM="${fromAddr}"`);
    else if(pr==='smtp')L.push(`SMTP_FALLBACK_HOST="${v.SMTP_FALLBACK_HOST||''}"`,`SMTP_FALLBACK_PORT="${v.SMTP_FALLBACK_PORT||'587'}"`,`SMTP_FALLBACK_USER="${v.SMTP_FALLBACK_USER||''}"`,`SMTP_FALLBACK_PASS="${v.SMTP_FALLBACK_PASS||''}"`);
    L.push(`DKIM_SELECTOR="${v.DKIM_SELECTOR||'melusina'}"`);
    if(v.MERMAIL_ADMIN_TOKEN)L.push(`MERMAIL_ADMIN_TOKEN="${v.MERMAIL_ADMIN_TOKEN}"`);
  }

  sec('Monitoring ‚Äî Wolfdog',[
    `WATCHDOG_TG_TOKEN="${v.WATCHDOG_TG_TOKEN||''}"`,
    `WATCHDOG_TG_CHAT_ID="${v.WATCHDOG_TG_CHAT_ID||''}"`,
    v.WATCHDOG_TG_ADMINS?`WATCHDOG_TG_ADMINS="${v.WATCHDOG_TG_ADMINS}"`:null,
    v.WATCHDOG_AUTH_PAGE_URL?`WATCHDOG_AUTH_PAGE_URL="${v.WATCHDOG_AUTH_PAGE_URL}"`:null,
    v.ALERT_BACKOFF_SCHEDULE?`ALERT_BACKOFF_SCHEDULE="${v.ALERT_BACKOFF_SCHEDULE}"`:null
  ]);

  const adv=['MELUSINA_AUTO_BOOT','MELUSINA_SIDECAR_AUTOSTART','MELUSINA_DEPLOY_TIMEOUT','MELUSINA_HEALTH_INTERVAL','MELUSINA_MTU','MELUSINA_DNS_TTL','MELUSINA_LOG_DIR','MELUSINA_BACKUP_DIR','MELUSINA_CERT_EMAIL'];
  const al=adv.filter(k=>v[k]!==undefined&&v[k]!=='').map(k=>`${k}="${v[k]}"`);
  if(al.length)sec('Advanced',al);

  const out=L.join('\n')+'\n';
  document.getElementById('env-out').textContent=out;document.getElementById('env-out').style.display='block';
}
function copyEnv(){const t=document.getElementById('env-out').textContent;if(!t){toast('Generate first');return}
  navigator.clipboard.writeText(t).then(()=>toast('Copied')).catch(()=>toast('Failed'))}
function dlEnv(){const t=document.getElementById('env-out').textContent;if(!t){toast('Generate first');return}
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([t],{type:'text/plain'}));a.download='deployment.env';a.click();toast('Downloaded')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function importFile(inp){const f=inp?.files?.[0];if(!f)return;
  const r=new FileReader();r.onload=()=>{parseImp(r.result);toast('Imported '+f.name)};r.readAsText(f)}
function parseImp(text){
  const kv={};text.split('\n').forEach(l=>{const m=l.match(/^([A-Z_][A-Z0-9_]*)="?([^"]*)"?$/);if(m)kv[m[1]]=m[2]});
  Object.keys(kv).forEach(k=>{S.v[k]=kv[k]});
  SC.forEach(s=>{const hk='SIDECAR_HOST_'+s.id;if(kv[hk]){S.sh[s.id]=kv[hk];S.svc[s.id]=true}});
  if(kv.MELUSINA_SIDECARS){const en=kv.MELUSINA_SIDECARS.split(',').map(x=>x.trim());SC.forEach(s=>{if(!s.req&&!en.includes(s.id))S.svc[s.id]=false})}
  if(kv.SIDECAR_HOSTS){S.hosts=kv.SIDECAR_HOSTS.split(',').map(x=>x.trim()).filter(x=>x!=='host').map(id=>{
    const p='SIDECAR_'+id.toUpperCase()+'_';return{id,conn:id.startsWith('remote')?'remote':'local',ip:kv[p+'IP']||'',ssh_user:kv[p+'SSH_USER']||'root',ssh_key:kv[p+'SSH_KEY']||''}})}
  if(kv.TELEGRAM_GATEWAY_TOKEN)S.v.OTP_ENABLED='true';
  save();boot();
}
function resetAll(){if(!confirm('Reset everything?'))return;sessionStorage.clear();fresh();boot();toast('Reset')}
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400)}

document.body.addEventListener('dragover',e=>e.preventDefault());
document.body.addEventListener('drop',e=>{e.preventDefault();const f=e.dataTransfer?.files?.[0];
  if(f&&(f.name.endsWith('.env')||f.name.endsWith('.txt'))){const r=new FileReader();r.onload=()=>{parseImp(r.result);toast('Imported '+f.name)};r.readAsText(f)}});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function boot(){
  bindAll();topo();deriveKh();deriveDns();reflow();updateMode();
  if(S.v.DEPLOY_TARGET)pickTarget(S.v.DEPLOY_TARGET);
  document.querySelectorAll('.ch[data-r]').forEach(el=>el.classList.toggle('on',S.v[el.dataset.r]===el.dataset.v));
  document.querySelectorAll('.tgl[data-k]').forEach(b=>b.classList.toggle('on',S.v[b.dataset.k]==='true'));
  detectW();renderResellers();
  // Auto-fetch resellers so user doesn't have to click a button
  fetchResellers().then(()=>{
    // Auto-select first top-level reseller if none selected
    if(!S.v.RESELLER_NFT_MINT&&_rl.length){
      const top=_rl.find(r=>r.top);if(top)pickReseller(top.mint);
    }else if(S.v.RESELLER_NFT_MINT){
      // Already selected ‚Äî make sure domain mode matches the fetched reseller data
      const r=_rl.find(x=>x.mint===S.v.RESELLER_NFT_MINT);
      if(r)updateDomainMode(r);
    }
  }).catch(()=>{});
  if(S.v.MELUSINA_DOMAIN)debounceLicenseCheck();
  // Re-detect wallets after extensions have time to inject (some are slow)
  setTimeout(detectW,1000);setTimeout(detectW,3000);
  // Also re-detect at 5s for Solflare which can be very slow to inject
  setTimeout(detectW,5000);
}
load();boot();
</script>
</body>
</html>
